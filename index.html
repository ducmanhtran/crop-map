<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>B·∫£n ƒë·ªì tr·ªìng tr·ªçt t·ª´ Google Sheets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    /* B·∫£n ƒë·ªì chi·∫øm ph·∫ßn c√≤n l·∫°i */
    #map { 
      height: calc(100vh - 100px);
      width: 100%; 
      margin: 0;
      padding: 0;
    }

    /* MENU NGANG */
    #menu {
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      position: relative;
      z-index: 1000;
    }

    #menu .menu {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }

    #menu .menu > li {
      position: relative;
    }

    #menu button {
      background: none;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #menu button:hover {
      background: #f0f0f0;
    }

    /* Submenu ·∫©n m·∫∑c ƒë·ªãnh */
    #menu .submenu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: #fff;
      list-style: none;
      margin: 0;
      padding: 4px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      min-width: 180px;
      z-index: 2000;
    }

    #menu .submenu li {
      text-align: left;
    }

    #menu .submenu button {
      width: 100%;
      text-align: left;
      padding: 8px 12px;
      font-size: 13px;
    }

    /* Hi·ªán submenu khi hover (desktop) */
    #menu .menu > li:hover > .submenu {
      display: block;
    }

    /* Footer g·ªçn h∆°n */
    #footerTitle {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      margin: 0;
      padding: 4px 6px;
      background: rgba(255,255,255,0.85);
      text-align: center;
      font-size: 13px;
      font-weight: normal;
      box-shadow: 0 -1px 4px rgba(0,0,0,0.15);
      z-index: 1000;
    }

    /* Responsive cho ƒëi·ªán tho·∫°i */
    @media (max-width: 768px) {
      #menu .menu {
        flex-direction: column;
        align-items: stretch;
      }

      #menu .menu > li {
        border-bottom: 1px solid #eee;
      }

      #menu button {
        width: 100%;
        text-align: left;
        padding: 10px;
        font-size: 14px;
      }

      /* Submenu trong mobile */
      #menu .submenu {
        position: static;
        box-shadow: none;
        min-width: 100%;
      }

      #menu .submenu button {
        padding-left: 24px;
      }

      /* M·∫∑c ƒë·ªãnh ·∫©n submenu tr√™n mobile */
      #menu .submenu {
        display: none;
      }

      /* Khi li c√≥ class "open" th√¨ hi·ªán submenu */
      #menu .menu > li.open > .submenu {
        display: block;
      }
    }
  </style>
</head>
<body>
  <!-- MENU NGANG D·∫†NG DROPDOWN -->
  <nav id="menu">
    <ul class="menu">
      <li>
        <button>C√¢y tr·ªìng ‚ñæ</button>
        <ul class="submenu">
          <li><button data-crop="all">üåç T·ªïng th·ªÉ</button></li>
          <li><button data-crop="C·ªè">üå± C·ªè</button></li>
          <li><button data-crop="Ng√¥">üåΩ Ng√¥</button></li>
          <li><button data-crop="S·∫Øn">ü•î S·∫Øn</button></li>
          <li><button data-crop="ƒê·∫•t tr·ªëng">‚¨ú ƒê·∫•t tr·ªëng</button></li>
        </ul>
      </li>

      <li>
        <button>C√¥ng vi·ªác ‚ñæ</button>
        <ul class="submenu">
          <li><button data-task="daily">üìÖ C√¥ng vi·ªác h√†ng ng√†y</button></li>
          <li><button data-task="note">üìù L∆∞u √Ω c√¥ng vi·ªác</button></li>
          <li><button data-task="weekly">üìä B√°o c√°o tu·∫ßn</button></li>
        </ul>
      </li>

      <li>
        <button>H·∫° t·∫ßng ‚ñæ</button>
        <ul class="submenu">
          <li><button data-infra="irrigation">üíß H·ªá th·ªëng t∆∞·ªõi</button></li>
          <li><button data-infra="machine">üöú M√°y m√≥c</button></li>
        </ul>
      </li>

      <li>
        <button>Ph√°p l√Ω ‚ñæ</button>
        <ul class="submenu">
          <li><button data-legal="land">üìñ S·ªï ƒë·ªè</button></li>
        </ul>
      </li>
    </ul>
  </nav>

  <div id="map"></div>

  <h2 id="footerTitle">B·∫£n ƒë·ªì tr·ªìng tr·ªçt (Demo Google Sheets)</h2>

  <script>
    window.onload = function() {
      // --- Khai b√°o URL tr∆∞·ªõc ---
      var sheetUrl = "https://docs.google.com/spreadsheets/d/13II_ZFEvrxK2qd0mkIX-0TNPdUH5ac4NFykmjqEPCZM/gviz/tq?tqx=out:json";

      var polygons = [];
      var rowsData = [];

      // --- Kh·ªüi t·∫°o b·∫£n ƒë·ªì ---
      var map = L.map('map', {
        center: [17.5089721, 106.4670833],
        zoom: 13,
        zoomControl: false
      });

      L.control.zoom({ position: 'bottomright' }).addTo(map);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // --- H√†m v·∫Ω d·ªØ li·ªáu ---
      function drawData(filterCrop) {
        polygons.forEach(p => map.removeLayer(p));
        polygons = [];

        rowsData.forEach(row => {
          var name = row.c[0]?.v;
          var area = row.c[1]?.v;
          var crop = row.c[2]?.v;
          var stage = row.c[3]?.v;
          var coords = JSON.parse(row.c[5]?.v);
          var harvestDateStr = row.c[4]?.v;

          if (filterCrop && filterCrop !== "all" && crop !== filterCrop) return;

          var color = "gray";
          var fillOpacity = 0.6;

          if (crop === "C·ªè") {
            color = "yellow";
          } else if (crop === "S·∫Øn") {
            color = "green";
          } else if (crop === "Ng√¥") {
            color = "orange";
          } else if (crop === "ƒê·∫•t tr·ªëng") {
            color = "brown";
            fillOpacity = 0.3;
          }

          var poly = L.polygon(coords, {
            color: "blue",
            weight: 0.5,
            fillColor: color,
            fillOpacity: fillOpacity
          }).addTo(map);

          poly.bindPopup(`
            <b>${name}</b><br>
            Di·ªán t√≠ch: ${area} ha<br>
            C√¢y: ${crop}<br>
            Giai ƒëo·∫°n: ${stage}<br>
            Ng√†y thu ho·∫°ch: ${harvestDateStr || "Ch∆∞a c√≥"}
          `);

          polygons.push(poly);
        });
      }

      // --- L·∫•y d·ªØ li·ªáu t·ª´ Google Sheets ---
      fetch(sheetUrl)
        .then(res => res.text())
        .then(data => {
          var json = JSON.parse(data.substr(47).slice(0, -2));
          rowsData = json.table.rows;
          drawData("all");
        });

      // --- B·∫Øt s·ª± ki·ªán ch·ªçn crop ---
      document.querySelectorAll("[data-crop]").forEach(btn => {
        btn.addEventListener("click", function() {
          var crop = this.getAttribute("data-crop");
          drawData(crop);
        });
      });

      // --- JS cho mobile menu ---
      if (window.innerWidth <= 768) {
        document.querySelectorAll("#menu .menu > li > button").forEach(btn => {
          btn.addEventListener("click", function(e) {
            e.preventDefault();
            var li = this.parentElement;

            document.querySelectorAll("#menu .menu > li").forEach(item => {
              if (item !== li) item.classList.remove("open");
            });

            li.classList.toggle("open");
          });
        });
      }
    };
  </script>
</body>
</html>
