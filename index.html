<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>B·∫£n ƒë·ªì tr·ªìng tr·ªçt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
/* MENU + MAP + FOOTER + LABELS (gi·ªëng nh∆∞ tr∆∞·ªõc) */
#menu { background: linear-gradient(90deg, #007bff, #0056b3); box-shadow:0 2px 6px rgba(0,0,0,0.25); position: relative; z-index: 1000; font-family: Arial,sans-serif;}
#menu .menu { list-style:none;margin:0;padding:0;display:flex;justify-content:center;}
#menu .menu>li {position:relative;}
#menu button {background:none;border:none;padding:14px 20px;font-size:15px;color:#fff;font-weight:600;cursor:pointer;transition:background 0.3s;display:flex;align-items:center;gap:6px;}
#menu button:hover {background:rgba(0,0,0,0.05);color:#007bff;}
#menu .submenu {display:none;position:absolute;top:100%;left:0;background:#fff;list-style:none;margin:0;padding:6px 0;box-shadow:0 2px 6px rgba(0,0,0,0.25);min-width:200px;border-radius:4px;}
#menu .submenu li{text-align:left;}
#menu .submenu button{width:100%;text-align:left;padding:10px 14px;font-size:14px;color:#333;background:none;border:none;}
#menu .submenu button:hover{background:#f0f0f0;color:#007bff;}
#menu .menu>li:hover>.submenu{display:block;}
@media (max-width:768px){
  #menu .menu {display:grid;grid-template-columns:1fr 1fr;grid-gap:4px;padding:4px;}
  #menu .menu>li {border:1px solid rgba(0,0,0,0.1);border-radius:6px;background:rgba(255,255,255,0.6);}
  #menu button{width:100%;justify-content:center;padding:16px 10px;font-size:15px;text-align:center;color:#000;}
  #menu .submenu{display:none;position:static;box-shadow:none;background:#fff;margin-top:2px;border-radius:4px;}
  #menu .menu>li.open>.submenu{display:block;}
}
#map{height:calc(100vh-100px);width:100%;margin:0;padding:0;}
#footerTitle{position:fixed;bottom:0;left:0;width:100%;margin:0;padding:4px 6px;background:rgba(255,255,255,0.85);text-align:center;font-size:13px;box-shadow:0 -1px 4px rgba(0,0,0,0.15);z-index:1000;}
.custom-label{font-weight:200;font-size:13px;color:#000;text-align:center;white-space:nowrap;}
.toggle-labels-btn{background:#fff;border:1px solid #bbb;border-radius:6px;padding:6px 10px;font-size:14px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.15);margin-bottom:40px;}
.toggle-labels-btn:hover{background:#f0f0f0;}
#infoBox{position:fixed;bottom:40px;left:10px;background:rgba(255,255,255,0.9);border:1px solid #ccc;padding:8px 12px;font-size:14px;font-weight:bold;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);z-index:1200;}

/* POPUP TASK */
#taskPopup{display:none;position:fixed;top:100px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.95);border:1px solid #ccc;padding:12px;border-radius:6px;z-index:1300;max-width:90%;}
#taskPopup table{width:100%;border-collapse:collapse;}
#taskPopup th,#taskPopup td{border:1px solid #aaa;padding:4px 6px;text-align:left;font-size:13px;}
#taskPopup th{background:#f0f0f0;}
#taskPopup button{margin-left:4px;}
</style>
</head>
<body>

<nav id="menu">
  <ul class="menu">
    <li>
      <button>üå± C√¢y tr·ªìng ‚ñæ</button>
      <ul class="submenu">
        <li><button data-crop="all">üåç T·ªïng th·ªÉ</button></li>
        <li><button data-crop="C·ªè">üå± C·ªè</button></li>
        <li><button data-crop="Ng√¥">üåΩ Ng√¥</button></li>
        <li><button data-crop="S·∫Øn">ü•î S·∫Øn</button></li>
        <li><button data-crop="ƒê·∫•t tr·ªëng">‚¨ú ƒê·∫•t tr·ªëng</button></li>
      </ul>
    </li>
    <li>
      <button>üõ†Ô∏è C√¥ng vi·ªác ‚ñæ</button>
      <ul class="submenu">
        <li><button id="dailyTasksBtn">üìÖ C√¥ng vi·ªác h√†ng ng√†y</button></li>
        <li><button>üìù L∆∞u √Ω c√¥ng vi·ªác</button></li>
        <li><button>üìä B√°o c√°o tu·∫ßn</button></li>
      </ul>
    </li>
  </ul>
</nav>

<div id="map"></div>
<h2 id="footerTitle">B·∫£n ƒë·ªì tr·ªìng tr·ªçt H√≤a Ph√°t Qu·∫£ng B√¨nh</h2>
<div id="infoBox" style="display:none;">üå± C·ªè ch∆∞a thu ho·∫°ch: 0 ha</div>

<div id="taskPopup">
  <label>Ch·ªçn ng√†y: <input type="date" id="taskDate"></label>
  <button id="loadTasks">Xem c√¥ng vi·ªác</button>
  <button id="closeTasks">ƒê√≥ng</button>
  <div id="taskTableContainer" style="margin-top:10px; max-height:300px; overflow:auto;"></div>
</div>

<script>
// ================== INIT MAP ==================
const map = L.map('map',{center:[17.5089721,106.4670833],zoom:13,zoomControl:false});
L.control.zoom({position:'bottomright'}).addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

let polygons=[],labels=[],rowsData=[],taskPolygons=[],currentFilter="all";

// ================== HELPER ==================
function parseDate_fromSheet(str){
  if(!str) return null;
  str=String(str).trim();
  if(str.includes("/")){
    const parts=str.split("/");
    if(parts.length===3) return new Date(parts[2],parts[1]-1,parts[0]);
  }
  const m=str.match(/Date\((\d+),(\d+),(\d+)\)/);
  if(m) return new Date(parseInt(m[1]),parseInt(m[2]),parseInt(m[3]));
  return null;
}

function fetchSheetJSON(sheetUrl){
  return fetch(sheetUrl)
    .then(res=>res.text())
    .then(txt=>{
      const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
      if(!m) throw "Kh√¥ng parse ƒë∆∞·ª£c JSON t·ª´ sheet";
      return JSON.parse(m[1]);
    });
}

// ================== DRAW POLYGONS ==================
function updateLabelsVisibility(labelsVisible){
  labels.forEach(l=>map.removeLayer(l));
  if(!labelsVisible) return;
  labels.forEach(l=>{ if(currentFilter==="all" || l.options.crop===currentFilter) l.addTo(map); });
}

function drawData(filterCrop){
  polygons.forEach(p=>map.removeLayer(p));
  polygons=[]; labels.forEach(l=>map.removeLayer(l)); labels=[];
  currentFilter=filterCrop;
  let totalGrassArea=0,totalCassavaArea=0;

  rowsData.forEach(row=>{
    const name=row.c[0]?.v, area=parseFloat(row.c[1]?.v)||0, crop=row.c[2]?.v, stage=row.c[3]?.v, dateStr=row.c[4]?.v;
    const coords = JSON.parse(row.c[5]?.v||"[]");
    if(!coords || coords.length===0) return;
    if(filterCrop!=="all" && crop!==filterCrop) return;

    let color="blue",fillColor="gray",fillOpacity=0.6,weight=0.5;
    if(filterCrop==="all"){
      if(crop==="C·ªè") fillColor="yellow";
      else if(crop==="Ng√¥") fillColor="orange";
      else if(crop==="S·∫Øn") fillColor="green";
      else if(crop==="ƒê·∫•t tr·ªëng"){fillColor="brown";fillOpacity=0.3;}
    } else {
      if(crop==="C·ªè"){fillColor="yellow"; const harvestDate=parseDate_fromSheet(dateStr); if(harvestDate){const days=Math.floor((new Date()-harvestDate)/(1000*60*60*24)); if(days<0){fillOpacity=0.3; totalGrassArea+=area;} else {fillOpacity=Math.min(1,days/90); if(days>=90){color="red";weight=2;}}} else totalGrassArea+=area;}
      else if(crop==="Ng√¥") fillColor="orange";
      else if(crop==="S·∫Øn"){fillColor="green"; const plantedDate=parseDate_fromSheet(dateStr); if(plantedDate){const months=(new Date()-plantedDate)/(1000*60*60*24*30); if(months>=10){color="red";weight=2; totalCassavaArea+=area;}}}
      else if(crop==="ƒê·∫•t tr·ªëng"){fillColor="brown";fillOpacity=0.3;}
    }

    const poly=L.polygon(coords,{color,weight,fillColor,fillOpacity}).addTo(map);
    poly.bindPopup(`<b>${name}</b><br>Di·ªán t√≠ch: ${area} ha<br>C√¢y: ${crop}<br>Giai ƒëo·∫°n: ${stage}<br>Ng√†y: ${dateStr||"Ch∆∞a c√≥"}`);
    polygons.push(poly);

    const label=L.marker(poly.getBounds().getCenter(),{icon:L.divIcon({className:"custom-label",html:`${name}<br>${area} ha`}),crop:crop});
    labels.push(label);
  });

  updateLabelsVisibility(false);

  const box=document.getElementById("infoBox");
  if(filterCrop==="C·ªè"){box.style.display="block"; box.innerText=`üå± C·ªè ch∆∞a thu ho·∫°ch: ${totalGrassArea.toFixed(2)} ha`;}
  else if(filterCrop==="S·∫Øn"){box.style.display="block"; box.innerText=`ü•î S·∫Øn ƒë·∫øn h·∫°n thu ho·∫°ch: ${totalCassavaArea.toFixed(2)} ha`;}
  else box.style.display="none";
}

// ================== TOGGLE LABELS ==================
const toggleBtn=L.control({position:'bottomright'});
toggleBtn.onAdd=function(){
  const btn=L.DomUtil.create('button','toggle-labels-btn'); btn.innerHTML="üëÅÔ∏è Hi·ªán nh√£n";
  btn.onclick=function(){labelsVisible=!labelsVisible; btn.innerHTML=labelsVisible?"üôà ·∫®n nh√£n":"üëÅÔ∏è Hi·ªán nh√£n"; updateLabelsVisibility(labelsVisible);}
  let labelsVisible=false; return btn;
};
toggleBtn.addTo(map);

// ================== LOAD SHEETS ==================
const sheetCropsUrl="https://docs.google.com/spreadsheets/d/e/.../gviz/tq?tqx=out:json&sheet=Trang%20tinh1";
const sheetTasksUrl="https://docs.google.com/spreadsheets/d/e/.../gviz/tq?tqx=out:json&sheet=Cong%20viec%20hang%20ngay";

fetchSheetJSON(sheetCropsUrl).then(json=>{rowsData=json.table.rows; drawData("all");});

// ================== MENU BUTTONS ==================
document.querySelectorAll("[data-crop]").forEach(btn=>btn.addEventListener("click",function(){drawData(this.getAttribute("data-crop"));}));

// ================== DAILY TASKS ==================
const taskPopup=document.getElementById("taskPopup");
const taskDateInput=document.getElementById("taskDate");
document.getElementById("dailyTasksBtn").addEventListener("click",()=>{taskPopup.style.display="block"; taskDateInput.valueAsDate=new Date();});
document.getElementById("closeTasks").addEventListener("click",()=>{taskPopup.style.display="none"; taskPolygons.forEach(p=>p.setStyle({color:'blue',weight:0.5})); taskPolygons=[];});

document.getElementById("loadTasks").addEventListener("click",()=>{
  const selectedDate=taskDateInput.value ? new Date(taskDateInput.value) : new Date();
  fetchSheetJSON(sheetTasksUrl).then(json=>{
    const rows=json.table.rows;
    const tasksByLot={};
    taskPolygons.forEach(p=>p.setStyle({color:'blue',weight:0.5}));
    taskPolygons=[];
    rows.forEach(row=>{
      const rowDate=parseDate_fromSheet(row.c[1]?.v);
      if(!rowDate) return;
      if(rowDate.toDateString()!==selectedDate.toDateString()) return;
      const lot=row.c[2]?.v; if(!lot) return;
      if(!tasksByLot[lot]) tasksByLot[lot]=[];
      tasksByLot[lot].push({content:row.c[3]?.v||"", quantity:row.c[4]?.v||""});
    });

    let tableHTML="<table><tr><th>S·ªë l√¥, th·ª≠a</th><th>N·ªôi dung c√¥ng vi·ªác</th><th>Kh·ªëi l∆∞·ª£ng</th></tr>";
    for(let lot in tasksByLot){
      const tasks=tasksByLot[lot];
      tasks.forEach((t,i)=>{
        tableHTML+=`<tr>${i===0?`<td rowspan="${tasks.length}">${lot}</td>`:""}<td>${t.content}</td><td>${t.quantity}</td></tr>`;
      });
      const poly=polygons.find(p=>p.getPopup().getContent().includes(lot));
      if(poly){poly.setStyle({color:'red',weight:2}); taskPolygons.push(poly);}
    }
    tableHTML+="</table>";
    document.getElementById("taskTableContainer").innerHTML=tableHTML;
  });
});

// ================== MOBILE MENU ==================
if(window.innerWidth<=768){
  document.querySelectorAll("#menu .menu>li>button").forEach(btn=>{
    btn.addEventListener("click",function(e){e.preventDefault();
      const li=this.parentElement;
      document.querySelectorAll("#menu .menu>li").forEach(item=>{if(item!==li)item.classList.remove("open");});
      li.classList.toggle("open");
    });
  });
}
</script>
</body>
</html>
