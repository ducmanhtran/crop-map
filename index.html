<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>B·∫£n ƒë·ªì tr·ªìng tr·ªçt - Ho√† Ph√°t Qu·∫£ng B√¨nh</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
/* ===== MENU ===== */
#menu{background:linear-gradient(90deg,#007bff,#0056b3);box-shadow:0 2px 6px rgba(0,0,0,0.25);position:relative;z-index:1000;font-family:Arial,sans-serif;}
#menu .menu{list-style:none;margin:0;padding:0;display:flex;justify-content:center;}
#menu .menu>li{position:relative;}
#menu button{background:none;border:none;padding:14px 20px;font-size:15px;color:#fff;font-weight:600;cursor:pointer;transition:background 0.3s;display:flex;align-items:center;gap:6px;}
#menu button:hover{background:rgba(0,0,0,0.05);color:#007bff;}
#menu .submenu{display:none;position:absolute;top:100%;left:0;background:#fff;list-style:none;margin:0;padding:6px 0;box-shadow:0 2px 6px rgba(0,0,0,0.25);min-width:200px;border-radius:4px;}
#menu .submenu li{text-align:left;}
#menu .submenu button{width:100%;text-align:left;padding:10px 14px;font-size:14px;color:#333;background:none;border:none;}
#menu .submenu button:hover{background:#f0f0f0;color:#007bff;}
#menu .menu>li:hover>.submenu{display:block;}
#menu .submenu label{
  font-size:14px;
  color:#333;
  display:block;
  cursor:pointer;
}
@media(max-width:768px){
  #infoBox{bottom:80px;left:5px;font-size:13px;padding:6px 10px;}
  #menu .menu{display:grid;grid-template-columns:1fr 1fr;grid-gap:4px;padding:4px;}
  #menu .menu>li{border:1px solid rgba(0,0,0,0.1);border-radius:6px;background:rgba(255,255,255,0.6);}
  #menu button{width:100%;justify-content:center;padding:16px 10px;font-size:15px;text-align:center;color:#000;}
  #menu button i{display:block;font-size:20px;margin-bottom:4px;}
  #menu .submenu{display:none;position:static;box-shadow:none;background:#fff;margin-top:2px;border-radius:4px;}
  #menu .submenu button{text-align:left;padding:10px 14px;font-size:14px;color:#333;}
  #menu .submenu button:hover{background:#f0f0f0;color:#007bff;}
  #menu .menu>li.open>.submenu{display:block;}
}
/* ===== MAP + FOOTER ===== */
#map{height:calc(100vh - 100px);width:100%;margin:0;padding:0;}
#footerTitle{position:fixed;bottom:0;left:0;width:100%;margin:0;padding:4px 6px;background:rgba(255,255,255,0.85);text-align:center;font-size:13px;box-shadow:0 -1px 4px rgba(0,0,0,0.15);z-index:1000;}
/* ===== LABEL & TOGGLE ===== */
.custom-label{font-weight:200;font-size:13px;color:#000;text-align:center;white-space:nowrap;}
.toggle-labels-btn{background:#fff;border:1px solid #bbb;border-radius:6px;padding:6px 10px;font-size:14px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.15);margin-bottom:40px;}
.toggle-labels-btn:hover{background:#f0f0f0;}
#infoBox{position:fixed;bottom:40px;left:10px;background:rgba(255,255,255,0.9);border:1px solid #ccc;padding:8px 12px;font-size:14px;font-weight:bold;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);z-index:1200;}
/* ===== TASK PANEL ===== */
#taskPanel{position:fixed;top:60px;right:10px;width:280px;background:rgba(255,255,255,0.95);border:1px solid #ccc;padding:10px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);z-index:1200;display:none;}
#taskPanel label{font-weight:bold;}
#taskList{max-height:300px;overflow:auto;font-size:14px;margin-top:6px;}
#closeTasksBtn{
  background:none;
  border:none;
  color:#000;
  font-size:18px;
  cursor:pointer;
}

#taskPanel .task-content{
  max-height:250px;
  overflow:auto;
  padding:10px 14px;
  font-size:14px;
  line-height:1.4;
}

#taskPanel .date-label{
  display:block;
  margin:8px 14px 4px;
  font-weight:bold;
}

#taskDate{
  width:calc(100% - 28px);
  margin:0 14px 12px;
  padding:6px 8px;
  border:1px solid #ccc;
  border-radius:6px;
}

@media (max-width:768px){
  #taskPanel{
    position: fixed;       /* ch·∫Øc ch·∫Øn panel ƒë∆∞·ª£c ƒë·ªãnh v·ªã tuy·ªát ƒë·ªëi tr√™n m√†n h√¨nh */
    top:10px;
    bottom:auto;
    left:50%;              /* ƒë·∫∑t t√¢m c·ªßa panel ·ªü gi·ªØa m√†n h√¨nh */
    transform: translateX(-50%); /* d·ªãch tr√°i 1/2 chi·ªÅu r·ªông ƒë·ªÉ th·∫≠t s·ª± n·∫±m gi·ªØa */
    width:80%;
  }
}


#taskPanel .panel-header {
  position: relative;       /* ƒë·ªÉ ti√™u ƒë·ªÅ v·∫´n hi·ªÉn th·ªã b√¨nh th∆∞·ªùng */
  padding-right: 35px;      /* ch·ª´a kho·∫£ng cho n√∫t X */
}

#closeTasksBtn {
  position: absolute;
  top: 0;                   /* s√°t c·∫°nh tr√™n c·ªßa .panel-header */
  right: 0;                 /* s√°t m√©p ph·∫£i panel */
  background: none;
  border: none;
  font-size: 18px;          /* tu·ª≥ ch·ªânh */
  cursor: pointer;
  line-height: 1;           /* tr√°nh d√≠nh kho·∫£ng tr·ªëng */
}

.lot-item:hover { cursor:pointer; background:#f9f9f9; }
  /* Gi·ªëng ki·ªÉu ch·ªØ c·ªßa c√°c m·ª•c c·ªè, s·∫Øn */
#menu .submenu li label {
    font-family: inherit;        /* d√πng c√πng font v·ªõi menu */
    font-size: 14px;             /* ho·∫∑c c√πng size nh∆∞ n√∫t menu con */
    font-weight: 600;            /* n·∫øu m·ª•c c·ªè/s·∫Øn ƒëang ƒë·∫≠m th√¨ ƒë·ªÉ 600 */
    line-height: 1.4;
    display: flex;               /* cƒÉn checkbox v√† ch·ªØ ngang h√†ng */
    align-items: center;
    gap: 6px;                    /* kho·∫£ng c√°ch checkbox ‚Äì ch·ªØ */
}
#menu .submenu li label input[type="checkbox"] {
    transform: scale(1.1);       /* tu·ª≥ ch·ªânh: to h∆°n ch√∫t cho ƒë·ªìng ƒë·ªÅu */
    margin: 0;
}

</style>
</head>
<body>
<nav id="menu">
<ul class="menu">
<li><button>üå± C√¢y tr·ªìng ‚ñæ</button>
<ul class="submenu">
<li><button data-crop="all">üåç T·ªïng th·ªÉ</button></li>
<li><button data-crop="C·ªè">üå± C·ªè</button></li>
<li><button data-crop="Ng√¥">üåΩ Ng√¥</button></li>
<li><button data-crop="S·∫Øn">ü•î S·∫Øn</button></li>
<li><button data-crop="ƒê·∫•t tr·ªëng">‚¨ú ƒê·∫•t tr·ªëng</button></li>
</ul></li>
<li><button>üõ†Ô∏è C√¥ng vi·ªác ‚ñæ</button>
<ul class="submenu">
<li><button id="dailyTaskBtn">üìÖ C√¥ng vi·ªác h√†ng ng√†y</button></li>
</ul></li>
<li><button>üèóÔ∏è H·∫° t·∫ßng ‚ñæ</button>
<ul class="submenu">
<li><button>üíß H·ªá th·ªëng t∆∞·ªõi</button></li>
<li><button>üöú M√°y m√≥c</button></li>
</ul></li>
<li><button>üìú Ph√°p l√Ω ‚ñæ</button>
<ul class="submenu">
<li><label><input type="checkbox" id="chkCompanyLegal"> S·ªï ƒë·ªè c√¥ng ty</label></li>
<li><label><input type="checkbox" id="chkActualLots"> Hi·ªán tr·∫°ng </label></li>
<li><label><input type="checkbox" id="chkDisputed"> ƒê·∫•t l·∫•n chi·∫øm </label></li>
</ul>
</li>
</ul>
</nav>

<div id="map"></div>
<h2 id="footerTitle">B·∫£n ƒë·ªì tr·ªìng tr·ªçt H√≤a Ph√°t Qu·∫£ng B√¨nh</h2>
<div id="infoBox" style="display:none"></div>
<div id="taskPanel">
<div class="panel-header">
  <span id="taskPanelTitle">C√¥ng vi·ªác h√†ng ng√†y</span>
  <button id="closeTasksBtn">‚úñ</button>
</div>

  <div id="taskList" class="task-content"></div>

  <label for="taskDate" class="date-label">Ch·ªçn ng√†y:</label>
  <input type="date" id="taskDate">
</div>

<script>
window.onload=function(){
// ====== URLs (ƒë√£ cung c·∫•p)
const sheetCropsUrl = "https://docs.google.com/spreadsheets/d/13II_ZFEvrxK2qd0mkIX-0TNPdUH5ac4NFykmjqEPCZM/gviz/tq?tqx=out:json";
const sheetTaskUrl  = "https://docs.google.com/spreadsheets/d/13II_ZFEvrxK2qd0mkIX-0TNPdUH5ac4NFykmjqEPCZM/gviz/tq?tqx=out:json&gid=693737777";
const sheetLegalUrl = "https://docs.google.com/spreadsheets/d/1yLzyQRiZjOxwXDNL2gKtzTULA9ODTcS0bLXTOxqELBE/gviz/tq?tqx=out:json";
const sheetDisputedUrl = "https://docs.google.com/spreadsheets/d/1yLzyQRiZjOxwXDNL2gKtzTULA9ODTcS0bLXTOxqELBE/gviz/tq?tqx=out:json&gid=162449209";

// ----- state
let rowsData = [], polygons = [], labelsVisible = false;
let taskData = [], highlightLayers = [];

// index theo t√™n ƒë·ªÉ t√¨m polygon trong m·ªçi layer
const cropsByName = {};
const actualByName = {};
const legalByName = {};
const disputedByName = {};

// ----- map + groups
const map = L.map('map',{center:[17.5089721,106.4670833],zoom:13,zoomControl:false});
L.control.zoom({position:'bottomright'}).addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

const cropsGroup        = L.layerGroup().addTo(map);
const companyLegalGroup = L.layerGroup();
const actualLotsGroup   = L.layerGroup();
const disputedGroup     = L.layerGroup();
const highlightGroup    = L.layerGroup().addTo(map); // highlight overlay (lu√¥n t·ªìn t·∫°i)

// ----- toggle nh√£n
const toggleBtn = L.control({position:'bottomright'});
toggleBtn.onAdd = function(){
  const btn = L.DomUtil.create('button','toggle-labels-btn');
  btn.innerHTML = "üëÅÔ∏è Hi·ªán nh√£n";
  btn.onclick = function(){
    labelsVisible = !labelsVisible;
    polygons.forEach(p=>{ if(labelsVisible) map.addLayer(p.myTooltip); else map.removeLayer(p.myTooltip); });
    btn.innerHTML = labelsVisible?"üôà ·∫®n nh√£n":"üëÅÔ∏è Hi·ªán nh√£n";
  };
  return btn;
};
toggleBtn.addTo(map);

// ----- helpers parse
function parseDate_fromSheet(str){
  if(!str) return null;
  str = String(str).trim();
  if(str.includes('/')){
    const parts = str.split('/'); if(parts.length===3) return new Date(parts[2], parts[1]-1, parts[0]);
  }
  const match = str.match(/Date\((\d+),(\d+),(\d+)\)/);
  if(match) return new Date(+match[1], +match[2], +match[3]);
  const d = new Date(str); return isNaN(d)?null:d;
}
function parseTaskDate(dateStr){ if(!dateStr) return null; const m = dateStr.match(/Date\((\d+),(\d+),(\d+)\)/); if(m) return new Date(+m[1], +m[2], +m[3]); const d = new Date(dateStr); return isNaN(d)?null:d; }

// ----- draw crops (c·∫≠p nh·∫≠t index theo t√™n)
function drawCrops(filterCrop){
  cropsGroup.clearLayers(); polygons = []; Object.keys(cropsByName).forEach(k=>delete cropsByName[k]);

  const today = new Date();
  let totalGrassArea=0,totalCassavaArea=0,totalCornArea=0;
  rowsData.forEach(row=>{
    const [name,areaRaw,crop,stage,dateStr,coordsStr] = row.c.map(c=>c?.v);
    const area = parseFloat(areaRaw)||0;
    if(!coordsStr) return; if(filterCrop!=='all' && crop!==filterCrop) return;
    let coords; try{ coords = JSON.parse(coordsStr); }catch(e){ return; }
    let color='blue', fillColor='gray', fillOpacity=0.6, weight=0.5;
    const plantDate = parseDate_fromSheet(dateStr); const monthsElapsed = plantDate?((today-plantDate)/(1000*60*60*24*30)):0;
    if(filterCrop==='all'){
      if(crop==='C·ªè') fillColor='yellow'; else if(crop==='Ng√¥') fillColor='orange'; else if(crop==='S·∫Øn') fillColor='green'; else if(crop==='ƒê·∫•t tr·ªëng'){ fillColor='brown'; fillOpacity=0.3; }
    } else {
      if(crop==='C·ªè'){ fillColor='yellow'; if(monthsElapsed>=3){ color='red'; weight=2;totalGrassArea+=area } fillOpacity=Math.min(1, monthsElapsed/6); }
      else if(crop==='S·∫Øn'){ fillColor='green'; if(monthsElapsed>=10){ color='red'; weight=2;totalCassavaArea+=area;} fillOpacity=Math.min(1, monthsElapsed/6*3/10); }
      else if(crop==='Ng√¥'){ fillColor='orange'; if(monthsElapsed>=6){ color='red'; weight=2;totalCornArea+=area; } fillOpacity=Math.min(1, monthsElapsed/6*3/6); }
      else if(crop==='ƒê·∫•t tr·ªëng'){ fillColor='brown'; fillOpacity=0.3; }
    }
    const poly = L.polygon(coords,{color,weight,fillColor,fillOpacity}).addTo(cropsGroup);
    poly.options.name = name;
    const displayDate = plantDate ? `${plantDate.getDate()}/${plantDate.getMonth()+1}/${plantDate.getFullYear()}` : 'Ch∆∞a c√≥';
    poly.bindPopup(`<b>${name}</b><br>Di·ªán t√≠ch: ${area} ha<br>C√¢y: ${crop}<br>Giai ƒëo·∫°n: ${stage}<br>Ng√†y: ${displayDate}`);
    poly.myTooltip = L.tooltip({permanent:true,direction:'center',className:'custom-label'})
      .setContent(`${name}<br>${area} ha`).setLatLng(poly.getBounds().getCenter());
    polygons.push(poly);
    if(name) cropsByName[String(name)] = poly;
  });
  const box=document.getElementById("infoBox");
  if(filterCrop==="C·ªè") {box.style.display="block";box.innerText=`üå± C·ªè ƒë·∫øn h·∫°n thu ho·∫°ch: ${totalGrassArea.toFixed(2)} ha`;}
  else if(filterCrop==="S·∫Øn"){box.style.display="block";box.innerText=`ü•î S·∫Øn ƒë·∫øn h·∫°n thu ho·∫°ch: ${totalCassavaArea.toFixed(2)} ha`;}
  else if(filterCrop==="Ng√¥"){box.style.display="block";box.innerText=`üåΩ Ng√¥ ƒë·∫øn h·∫°n thu ho·∫°ch: ${totalCornArea.toFixed(2)} ha`;}
  else{box.style.display="none";}
}

// ----- fetch crops
fetch(sheetCropsUrl).then(r=>r.text()).then(data=>{
  const match = data.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
  if(!match) { console.error('Kh√¥ng parse ƒë∆∞·ª£c d·ªØ li·ªáu crops'); return; }
  try{ rowsData = JSON.parse(match[1]).table.rows; drawCrops('all'); }catch(e){ console.error('L·ªói parse crops',e); }
}).catch(e=>console.error('L·ªói fetch crops',e));

// ----- company legal
function drawCompanyLegal(){ legalByName && Object.keys(legalByName).forEach(k=>delete legalByName[k]); companyLegalGroup.clearLayers();
  fetch(sheetLegalUrl).then(r=>r.text()).then(txt=>{
    const match = txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
    if(!match) return;
    const rows = JSON.parse(match[1]).table.rows;
    rows.forEach(r=>{
      const [stt,name,areaRaw,coordsStr,note] = r.c.map(c=>c?.v);
      if(!coordsStr) return; let coords; try{ coords=JSON.parse(coordsStr);}catch(e){return;}
      const poly = L.polygon(coords,{color:'blue',weight:1,fillColor:'#add8e6',fillOpacity:0.4}).addTo(companyLegalGroup);
      poly.bindPopup(`<b>${name}</b><br>Di·ªán t√≠ch: ${areaRaw||''} ha<br>${note?note:''}`);
      if(name) legalByName[String(name)] = poly;
    });
  }).catch(err=>console.error('L·ªói fetch s·ªï ƒë·ªè:',err));
}

// ----- actual lots
function drawActualLots(){ actualByName && Object.keys(actualByName).forEach(k=>delete actualByName[k]); actualLotsGroup.clearLayers();
  rowsData.forEach(r=>{
    const [name,areaRaw,crop,stage,dateStr,coordsStr] = r.c.map(c=>c?.v);
    if(!coordsStr) return; let coords; try{ coords = JSON.parse(coordsStr);}catch(e){return;}
    const poly = L.polygon(coords,{color:'green',weight:1,fillColor:'#b0f2b6',fillOpacity:0.4}).addTo(actualLotsGroup);
    poly.bindPopup(`<b>${name}</b><br>${areaRaw} ha`);
    if(name) actualByName[String(name)] = poly;
  });
}

// ----- disputed
function drawDisputedLots(){ disputedByName && Object.keys(disputedByName).forEach(k=>delete disputedByName[k]); disputedGroup.clearLayers();
  fetch(sheetDisputedUrl).then(r=>r.text()).then(txt=>{
    const match = txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
    if(!match) return; const rows = JSON.parse(match[1]).table.rows;
    rows.forEach(r=>{
      const [stt,name,areaRaw,coordsStr,note] = r.c.map(c=>c?.v);
      if(!coordsStr) return; let coords; try{ coords = JSON.parse(coordsStr);}catch(e){return;}
      const poly = L.polygon(coords,{color:'red',weight:2,fillColor:'#f5b7b1',fillOpacity:0.5}).addTo(disputedGroup);
      poly.bindPopup(`<b>${name}</b><br>Di·ªán t√≠ch: ${areaRaw||''} ha<br>${note?note:''}`);
      if(name) disputedByName[String(name)] = poly;
    });
  }).catch(err=>console.error('L·ªói fetch disputed:',err));
}

// ----- helper: ki·ªÉm tra ph√°p l√Ω c√≥ checkbox n√†o ƒëang b·∫≠t
function anyLegalChecked(){
  return document.getElementById('chkCompanyLegal').checked || document.getElementById('chkActualLots').checked || document.getElementById('chkDisputed').checked;
}

// ----- checkbox events: khi b·∫≠t m·ª•c ph√°p l√Ω th√¨ t·∫Øt l·ªõp c√¢y tr·ªìng
document.getElementById('chkCompanyLegal').addEventListener('change', function(){
  if(this.checked){ if(map.hasLayer(cropsGroup)) map.removeLayer(cropsGroup);highlightGroup.clearLayers();  drawCompanyLegal(); map.addLayer(companyLegalGroup); }
  else{ companyLegalGroup.clearLayers(); map.removeLayer(companyLegalGroup); if(!anyLegalChecked()) map.addLayer(cropsGroup); }
});
document.getElementById('chkActualLots').addEventListener('change', function(){
  if(this.checked){ if(map.hasLayer(cropsGroup)) map.removeLayer(cropsGroup);highlightGroup.clearLayers();  drawActualLots(); map.addLayer(actualLotsGroup); }
  else{ actualLotsGroup.clearLayers(); map.removeLayer(actualLotsGroup); if(!anyLegalChecked()) map.addLayer(cropsGroup); }
});
document.getElementById('chkDisputed').addEventListener('change', function(){
  if(this.checked){ if(map.hasLayer(cropsGroup)) map.removeLayer(cropsGroup);highlightGroup.clearLayers();  drawDisputedLots(); map.addLayer(disputedGroup); }
  else{ disputedGroup.clearLayers(); map.removeLayer(disputedGroup); if(!anyLegalChecked()) map.addLayer(cropsGroup); }
});

// ----- fetch tasks
fetch(sheetTaskUrl).then(res=>res.text()).then(data=>{
  const match = data.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
  if(match) taskData = JSON.parse(match[1]).table.rows;
}).catch(e=>console.error('L·ªói fetch tasks:',e));

// ----- highlight helpers
function clearHighlights(){ highlightGroup.clearLayers(); highlightLayers = []; }

// ----- show tasks (t√¨m polygon theo t√™n trong m·ªçi layer index)
function showTasks(){
  if(!taskDateInput.value) return;
  const selectedDate = new Date(taskDateInput.value);
  document.getElementById('taskPanelTitle').textContent = 'C√¥ng vi·ªác ng√†y ' + String(selectedDate.getDate()).padStart(2,'0') + '/' + String(selectedDate.getMonth()+1).padStart(2,'0') + '/' + selectedDate.getFullYear();

  clearHighlights();

  const dayTasks = taskData.filter(row=>{ const [stt,dateStr,lot,content,quantity] = row.c.map(c=>c?.v); const d = parseTaskDate(dateStr); return d && d.toDateString() === selectedDate.toDateString(); });

  taskListDiv.innerHTML = '';
  const lotTasksMap = {};
  dayTasks.forEach(row=>{ const [stt,dateStr,lot,content,quantity] = row.c.map(c=>c?.v); if(!lot) return; if(!lotTasksMap[lot]) lotTasksMap[lot]=[]; lotTasksMap[lot].push({content,quantity}); });

  for(const lot in lotTasksMap){
    // t√¨m polygon trong index (crops, actual, legal, disputed)
    const poly = cropsByName[lot] || actualByName[lot] || legalByName[lot] || disputedByName[lot];
    if(poly){
      const highlight = L.polygon(poly.getLatLngs(),{color:'red',weight:3,fill:false}).addTo(highlightGroup);
      highlightLayers.push(highlight);
    }
    const tasksHTML = lotTasksMap[lot].map(t=>`- ${t.content} (${t.quantity||''})`).join('<br>');
    taskListDiv.innerHTML += `<div class="lot-item" data-lot="${lot}"><b>L√¥ ${lot}</b><br>${tasksHTML}</div><hr>`;
  }

  // hover effects: t·∫°o polygon nh·∫•p nh√°y trong highlightGroup
  document.querySelectorAll('#taskList .lot-item').forEach(item=>{
    let blink = null; let blinkPoly = null;
    item.addEventListener('mouseenter', ()=>{
      const lotName = item.dataset.lot;
      const basePoly = cropsByName[lotName] || actualByName[lotName] || legalByName[lotName] || disputedByName[lotName];
      if(!basePoly) return;
      const coords = basePoly.getLatLngs();
      // t·∫°o poly nh·∫•p nh√°y
      blinkPoly = L.polygon(coords,{color:'red',weight:0,fillColor:'red',fillOpacity:0}).addTo(highlightGroup);
      let visible = false;
      blink = setInterval(()=>{ blinkPoly.setStyle({fillOpacity: visible?0:0.4}); visible = !visible; }, 400);
      item.dataset.blinkId = blink;
      item.dataset.blinkPoly = '1';
    });
    item.addEventListener('mouseleave', ()=>{
      if(item.dataset.blinkId){ clearInterval(item.dataset.blinkId); }
      if(blinkPoly) { highlightGroup.removeLayer(blinkPoly); blinkPoly = null; }
      item.removeAttribute('data-blinkid');
    });
  });
}

// ----- UI: m·ªü panel c√¥ng vi·ªác
const taskPanel = document.getElementById('taskPanel');
const taskDateInput = document.getElementById('taskDate');
const taskListDiv = document.getElementById('taskList');

document.getElementById('dailyTaskBtn').addEventListener('click', function(){
  // khi m·ªü panel mu·ªën lu√¥n th·∫•y l·ªõp c√¢y tr·ªìng n·∫øu ch∆∞a c√≥ ph√°p l√Ω b·∫≠t
  if(!anyLegalChecked() && !map.hasLayer(cropsGroup)) map.addLayer(cropsGroup);
  const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth()+1).padStart(2,'0'); const dd = String(now.getDate()).padStart(2,'0');
  taskDateInput.value = `${yyyy}-${mm}-${dd}`;
  function updateTitle(){ const selected = new Date(taskDateInput.value); const today = new Date(); today.setHours(0,0,0,0); selected.setHours(0,0,0,0); const d = String(selected.getDate()).padStart(2,'0'); const m = String(selected.getMonth()+1).padStart(2,'0'); const y = selected.getFullYear(); const isFuture = selected.getTime() > today.getTime(); document.getElementById('taskPanelTitle').textContent = 'C√¥ng vi·ªác ng√†y ' + d + '/' + m + '/' + y + (isFuture? ' (d·ª± ki·∫øn)':''); }
  updateTitle(); taskDateInput.onchange = ()=>{ updateTaskPanelTitle(new Date(taskDateInput.value)); showTasks(); };
  taskPanel.style.display='block'; showTasks();
});

function updateTaskPanelTitle(selectedDate){ if(!selectedDate) return; const today = new Date(); today.setHours(0,0,0,0); selectedDate.setHours(0,0,0,0); const suffix = selectedDate>today? ' (d·ª± ki·∫øn)':''; const dd=String(selectedDate.getDate()).padStart(2,'0'); const mm=String(selectedDate.getMonth()+1).padStart(2,'0'); const yyyy=selectedDate.getFullYear(); document.getElementById('taskPanelTitle').textContent = 'C√¥ng vi·ªác ng√†y ' + dd + '/' + mm + '/' + yyyy + suffix; }

document.getElementById('taskDate').addEventListener('change', function(){ if(this.value) updateTaskPanelTitle(new Date(this.value)); showTasks(); });

document.getElementById('closeTasksBtn').addEventListener('click', function(){ taskPanel.style.display='none'; clearHighlights(); taskListDiv.innerHTML=''; });

// ----- crop filter buttons
document.querySelectorAll('[data-crop]').forEach(btn=>btn.addEventListener('click',function(){ drawCrops(this.dataset.crop); }));

// ----- mobile menu open/close
if(window.innerWidth<=768){ document.querySelectorAll('#menu .menu>li>button').forEach(btn=>{ btn.addEventListener('click',function(e){ e.preventDefault(); const li=this.parentElement; document.querySelectorAll('#menu .menu>li').forEach(item=>{ if(item!==li) item.classList.remove('open'); }); li.classList.toggle('open'); }); }); }

};
</script>
</body>
</html>












