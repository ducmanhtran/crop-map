<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báº£n Ä‘á»“ trá»“ng trá»t</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
  /* ===== MENU NGANG ===== */
  #menu {
    background: linear-gradient(90deg, #007bff, #0056b3);
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    position: relative;
    z-index: 1000;
    font-family: Arial, sans-serif;
  }
  #menu .menu {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
  }
  #menu .menu > li { position: relative; }
  #menu button {
    background: none;
    border: none;
    padding: 14px 20px;
    font-size: 15px;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  #menu button:hover { background: rgba(0,0,0,0.05); color: #007bff; }
  #menu .submenu {
    display: none;
    position: absolute;
    top: 100%; left: 0;
    background: #fff;
    list-style: none;
    margin: 0;
    padding: 6px 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    min-width: 200px;
    border-radius: 4px;
  }
  #menu .submenu li { text-align: left; }
  #menu .submenu button {
    width: 100%;
    text-align: left;
    padding: 10px 14px;
    font-size: 14px;
    color: #333;
    background: none;
    border: none;
  }
  #menu .submenu button:hover {
    background: #f0f0f0;
    color: #007bff;
  }
  #menu .menu > li:hover > .submenu { display: block; }

  /* ===== MENU MOBILE ===== */
  @media (max-width: 768px) {
    #menu .menu {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 4px;
      padding: 4px;
    }
    #menu .menu > li {
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 6px;
      background: rgba(255,255,255,0.6);
    }
    #menu button {
      width: 100%;
      justify-content: center;
      padding: 16px 10px;
      font-size: 15px;
      text-align: center;
      color: #000;
    }
    #menu button i {
      display: block;
      font-size: 20px;
      margin-bottom: 4px;
    }
    #menu .submenu {
      display: none;
      position: static;
      box-shadow: none;
      background: #fff;
      margin-top: 2px;
      border-radius: 4px;
    }
    #menu .submenu button {
      text-align: left;
      padding: 10px 14px;
      font-size: 14px;
      color: #333;
    }
    #menu .submenu button:hover {
      background: #f0f0f0;
      color: #007bff;
    }
    #menu .menu > li.open > .submenu { display: block; }
  }

  /* ===== MAP + FOOTER ===== */
  #map {
    height: calc(100vh - 100px);
    width: 100%;
    margin: 0; padding: 0;
  }
  #footerTitle {
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    margin: 0;
    padding: 4px 6px;
    background: rgba(255,255,255,0.85);
    text-align: center;
    font-size: 13px;
    box-shadow: 0 -1px 4px rgba(0,0,0,0.15);
    z-index: 1000;
  }
  </style>
</head>
<body>
  <!-- MENU -->
  <nav id="menu">
    <ul class="menu">
      <li>
        <button>ğŸŒ± CÃ¢y trá»“ng â–¾</button>
        <ul class="submenu">
          <li><button data-crop="all">ğŸŒ Tá»•ng thá»ƒ</button></li>
          <li><button data-crop="Cá»">ğŸŒ± Cá»</button></li>
          <li><button data-crop="NgÃ´">ğŸŒ½ NgÃ´</button></li>
          <li><button data-crop="Sáº¯n">ğŸ¥” Sáº¯n</button></li>
          <li><button data-crop="Äáº¥t trá»‘ng">â¬œ Äáº¥t trá»‘ng</button></li>
        </ul>
      </li>
      <li>
        <button>ğŸ› ï¸ CÃ´ng viá»‡c â–¾</button>
        <ul class="submenu">
          <li><button>ğŸ“… CÃ´ng viá»‡c hÃ ng ngÃ y</button></li>
          <li><button>ğŸ“ LÆ°u Ã½ cÃ´ng viá»‡c</button></li>
          <li><button>ğŸ“Š BÃ¡o cÃ¡o tuáº§n</button></li>
        </ul>
      </li>
      <li>
        <button>ğŸ—ï¸ Háº¡ táº§ng â–¾</button>
        <ul class="submenu">
          <li><button>ğŸ’§ Há»‡ thá»‘ng tÆ°á»›i</button></li>
          <li><button>ğŸšœ MÃ¡y mÃ³c</button></li>
        </ul>
      </li>
      <li>
        <button>ğŸ“œ PhÃ¡p lÃ½ â–¾</button>
        <ul class="submenu">
          <li><button>ğŸ“– Sá»• Ä‘á»</button></li>
        </ul>
      </li>
    </ul>
  </nav>

  <!-- MAP -->
  <div id="map"></div>
  <h2 id="footerTitle">Báº£n Ä‘á»“ trá»“ng trá»t HÃ²a PhÃ¡t Quáº£ng BÃ¬nh</h2>

  <script>
  window.onload = function() {
    const sheetUrl = "https://docs.google.com/spreadsheets/d/13II_ZFEvrxK2qd0mkIX-0TNPdUH5ac4NFykmjqEPCZM/gviz/tq?tqx=out:json";

    let polygons = [];
    let rowsData = [];

    // Parse ngÃ y tá»« Google Sheets
    function parseDate_fromSheet(str) {
      if (!str) return null;
      str = String(str).trim();

      if (str.includes("/")) {
        const parts = str.split("/");
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1;
          const year = parseInt(parts[2], 10);
          return new Date(year, month, day);
        }
      }

      const match = str.match(/Date\((\d+),(\d+),(\d+)\)/);
      if (match) {
        const year = parseInt(match[1], 10);
        const month = parseInt(match[2], 10);
        const day = parseInt(match[3], 10);
        return new Date(year, month, day);
      }
      return null;
    }

    // Khá»Ÿi táº¡o báº£n Ä‘á»“
    const map = L.map('map', {
      center: [17.5089721, 106.4670833],
      zoom: 13,
      zoomControl: false
    });
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Váº½ dá»¯ liá»‡u
    function drawData(filterCrop) {
      polygons.forEach(p => map.removeLayer(p));
      polygons = [];

      rowsData.forEach(row => {
        const name = row.c[0]?.v;
        const area = row.c[1]?.v;
        const crop = row.c[2]?.v;
        const stage = row.c[3]?.v;
        const harvestDateStr = row.c[4]?.v;
        const coords = JSON.parse(row.c[5]?.v);
        if (!coords) return;
        if (filterCrop && filterCrop !== "all" && crop !== filterCrop) return;

        let color = "gray", fillColor = "gray", fillOpacity = 0.6, weight = 0.5;

        if (crop === "Cá»") {
          fillColor = "yellow"; // ná»n vÃ ng
          color = "yellow";     // viá»n máº·c Ä‘á»‹nh
          const harvestDate = parseDate_fromSheet(harvestDateStr);
          if (harvestDate) {
            const today = new Date();
            const days = Math.floor((today - harvestDate) / (1000 * 60 * 60 * 24));
            fillOpacity = Math.min(1, days / 90);
            if (days >= 90) {
              color = "red"; // viá»n Ä‘á»
              weight = 2;
            }
          }
        } else if (crop === "NgÃ´") {
          color = "orange"; fillColor = "orange";
        } else if (crop === "Sáº¯n") {
          color = "green"; fillColor = "green";
        } else if (crop === "Äáº¥t trá»‘ng") {
          color = "brown"; fillColor = "brown"; fillOpacity = 0.3;
        }

        const poly = L.polygon(coords, {
          color: color,       // viá»n
          weight: weight,
          fillColor: fillColor, // ná»n
          fillOpacity: fillOpacity
        }).addTo(map);

        poly.bindPopup(`
          <b>${name}</b><br>
          Diá»‡n tÃ­ch: ${area} ha<br>
          CÃ¢y: ${crop}<br>
          Giai Ä‘oáº¡n: ${stage}<br>
          NgÃ y thu hoáº¡ch: ${harvestDateStr || "ChÆ°a cÃ³"}
        `);

        polygons.push(poly);
      });
    }

    // Láº¥y dá»¯ liá»‡u tá»« Google Sheets
    fetch(sheetUrl)
      .then(res => res.text())
      .then(data => {
        const json = JSON.parse(data.substr(47).slice(0, -2));
        rowsData = json.table.rows;
        drawData("all");
      });

    // Chá»n crop
    document.querySelectorAll("[data-crop]").forEach(btn => {
      btn.addEventListener("click", function() {
        const crop = this.getAttribute("data-crop");
        drawData(crop);
      });
    });

    // Mobile menu
    if (window.innerWidth <= 768) {
      document.querySelectorAll("#menu .menu > li > button").forEach(btn => {
        btn.addEventListener("click", function(e) {
          e.preventDefault();
          const li = this.parentElement;
          document.querySelectorAll("#menu .menu > li").forEach(item => {
            if (item !== li) item.classList.remove("open");
          });
          li.classList.toggle("open");
        });
      });
    }
  };
  </script>
</body>
</html>
