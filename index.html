<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báº£n Ä‘á»“ trá»“ng trá»t tá»« Google Sheets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    /* Báº£n Ä‘á»“ chiáº¿m pháº§n cÃ²n láº¡i */
    #map { 
      height: calc(100vh - 100px);
      width: 100%; 
      margin: 0;
      padding: 0;
    }

    /* MENU NGANG */
    #menu {
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      position: relative;
      z-index: 1000;
    }

    #menu .menu {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }

    #menu .menu > li {
      position: relative;
    }

    #menu button {
      background: none;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #menu button:hover {
      background: #f0f0f0;
    }

    /* Submenu áº©n máº·c Ä‘á»‹nh */
    #menu .submenu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: #fff;
      list-style: none;
      margin: 0;
      padding: 4px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      min-width: 180px;
      z-index: 2000;
    }

    #menu .submenu li {
      text-align: left;
    }

    #menu .submenu button {
      width: 100%;
      text-align: left;
      padding: 8px 12px;
      font-size: 13px;
    }

    /* Hiá»‡n submenu khi hover (desktop) */
    #menu .menu > li:hover > .submenu {
      display: block;
    }

    /* Footer gá»n hÆ¡n */
    #footerTitle {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      margin: 0;
      padding: 4px 6px;
      background: rgba(255,255,255,0.85);
      text-align: center;
      font-size: 13px;
      font-weight: normal;
      box-shadow: 0 -1px 4px rgba(0,0,0,0.15);
      z-index: 1000;
    }

    /* Responsive cho Ä‘iá»‡n thoáº¡i */
    @media (max-width: 768px) {
      #menu .menu {
        flex-direction: column;
        align-items: stretch;
      }

      #menu .menu > li {
        border-bottom: 1px solid #eee;
      }

      #menu button {
        width: 100%;
        text-align: left;
        padding: 10px;
        font-size: 14px;
      }

      /* Submenu trong mobile */
      #menu .submenu {
        position: static;
        box-shadow: none;
        min-width: 100%;
      }

      #menu .submenu button {
        padding-left: 24px;
      }

      /* Máº·c Ä‘á»‹nh áº©n submenu trÃªn mobile */
      #menu .submenu {
        display: none;
      }

      /* Khi li cÃ³ class "open" thÃ¬ hiá»‡n submenu */
      #menu .menu > li.open > .submenu {
        display: block;
      }
    }
  </style>
</head>
<body>
  <!-- MENU NGANG Dáº NG DROPDOWN -->
  <nav id="menu">
    <ul class="menu">
      <li>
        <button>ğŸŒ±CÃ¢y trá»“ng â–¾</button>
        <ul class="submenu">
          <li><button data-crop="all">ğŸŒ Tá»•ng thá»ƒ</button></li>
          <li><button data-crop="Cá»">ğŸŒ± Cá»</button></li>
          <li><button data-crop="NgÃ´">ğŸŒ½ NgÃ´</button></li>
          <li><button data-crop="Sáº¯n">ğŸ¥” Sáº¯n</button></li>
          <li><button data-crop="Äáº¥t trá»‘ng">â¬œ Äáº¥t trá»‘ng</button></li>
        </ul>
      </li>

      <li>
        <button>ğŸ› ï¸CÃ´ng viá»‡c â–¾</button>
        <ul class="submenu">
          <li><button data-task="daily">ğŸ“… CÃ´ng viá»‡c hÃ ng ngÃ y</button></li>
          <li><button data-task="note">ğŸ“ LÆ°u Ã½ cÃ´ng viá»‡c</button></li>
          <li><button data-task="weekly">ğŸ“Š BÃ¡o cÃ¡o tuáº§n</button></li>
        </ul>
      </li>

      <li>
        <button>ğŸ—ï¸Háº¡ táº§ng â–¾</button>
        <ul class="submenu">
          <li><button data-infra="irrigation">ğŸ’§ Há»‡ thá»‘ng tÆ°á»›i</button></li>
          <li><button data-infra="machine">ğŸšœ MÃ¡y mÃ³c</button></li>
        </ul>
      </li>

      <li>
        <button>ğŸ“œPhÃ¡p lÃ½ â–¾</button>
        <ul class="submenu">
          <li><button data-legal="land">ğŸ“– Sá»• Ä‘á»</button></li>
        </ul>
      </li>
    </ul>
  </nav>

  <div id="map"></div>

  <h2 id="footerTitle">Báº£n Ä‘á»“ trá»“ng trá»t HÃ²a PhÃ¡t Quáº£ng BÃ¬nh </h2>

  <script>
    window.onload = function() {
      // --- Khai bÃ¡o URL trÆ°á»›c ---
      var sheetUrl = "https://docs.google.com/spreadsheets/d/13II_ZFEvrxK2qd0mkIX-0TNPdUH5ac4NFykmjqEPCZM/gviz/tq?tqx=out:json";

      var polygons = [];
      var rowsData = [];

      // --- Khá»Ÿi táº¡o báº£n Ä‘á»“ ---
      var map = L.map('map', {
        center: [17.5089721, 106.4670833],
        zoom: 13,
        zoomControl: false
      });

      L.control.zoom({ position: 'bottomright' }).addTo(map);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // --- HÃ m váº½ dá»¯ liá»‡u ---
      function drawData(filterCrop) {
        polygons.forEach(p => map.removeLayer(p));
        polygons = [];

        rowsData.forEach(row => {
          var name = row.c[0]?.v;
          var area = row.c[1]?.v;
          var crop = row.c[2]?.v;
          var stage = row.c[3]?.v;
          var coords = JSON.parse(row.c[5]?.v);
          var harvestDateStr = row.c[4]?.v;

          if (filterCrop && filterCrop !== "all" && crop !== filterCrop) return;

          var color = "gray";
          var fillOpacity = 0.6;

          if (crop === "Cá»") {
            color = "yellow";
          } else if (crop === "Sáº¯n") {
            color = "green";
          } else if (crop === "NgÃ´") {
            color = "orange";
          } else if (crop === "Äáº¥t trá»‘ng") {
            color = "brown";
            fillOpacity = 0.3;
          }

          var poly = L.polygon(coords, {
            color: "blue",
            weight: 0.5,
            fillColor: color,
            fillOpacity: fillOpacity
          }).addTo(map);

          poly.bindPopup(`
            <b>${name}</b><br>
            Diá»‡n tÃ­ch: ${area} ha<br>
            CÃ¢y: ${crop}<br>
            Giai Ä‘oáº¡n: ${stage}<br>
            NgÃ y thu hoáº¡ch: ${harvestDateStr || "ChÆ°a cÃ³"}
          `);

          polygons.push(poly);
        });
      }

      // --- Láº¥y dá»¯ liá»‡u tá»« Google Sheets ---
      fetch(sheetUrl)
        .then(res => res.text())
        .then(data => {
          var json = JSON.parse(data.substr(47).slice(0, -2));
          rowsData = json.table.rows;
          drawData("all");
        });

      // --- Báº¯t sá»± kiá»‡n chá»n crop ---
      document.querySelectorAll("[data-crop]").forEach(btn => {
        btn.addEventListener("click", function() {
          var crop = this.getAttribute("data-crop");
          drawData(crop);
        });
      });

      // --- JS cho mobile menu ---
      if (window.innerWidth <= 768) {
        document.querySelectorAll("#menu .menu > li > button").forEach(btn => {
          btn.addEventListener("click", function(e) {
            e.preventDefault();
            var li = this.parentElement;

            document.querySelectorAll("#menu .menu > li").forEach(item => {
              if (item !== li) item.classList.remove("open");
            });

            li.classList.toggle("open");
          });
        });
      }
    };
  </script>
</body>
</html>

