<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Báº£n Ä‘á»“ trá»“ng trá»t</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
/* ===== MENU ===== */
#menu{background:linear-gradient(90deg,#007bff,#0056b3);box-shadow:0 2px 6px rgba(0,0,0,0.25);position:relative;z-index:1000;font-family:Arial,sans-serif;}
#menu .menu{list-style:none;margin:0;padding:0;display:flex;justify-content:center;}
#menu .menu>li{position:relative;}
#menu button{background:none;border:none;padding:14px 20px;font-size:15px;color:#fff;font-weight:600;cursor:pointer;transition:background 0.3s;display:flex;align-items:center;gap:6px;}
#menu button:hover{background:rgba(0,0,0,0.05);color:#007bff;}
#menu .submenu{display:none;position:absolute;top:100%;left:0;background:#fff;list-style:none;margin:0;padding:6px 0;box-shadow:0 2px 6px rgba(0,0,0,0.25);min-width:200px;border-radius:4px;}
#menu .submenu li{text-align:left;}
#menu .submenu button{width:100%;text-align:left;padding:10px 14px;font-size:14px;color:#333;background:none;border:none;}
#menu .submenu button:hover{background:#f0f0f0;color:#007bff;}
#menu .menu>li:hover>.submenu{display:block;}
@media(max-width:768px){
  #infoBox{bottom:80px;left:5px;font-size:13px;padding:6px 10px;}
  #menu .menu{display:grid;grid-template-columns:1fr 1fr;grid-gap:4px;padding:4px;}
  #menu .menu>li{border:1px solid rgba(0,0,0,0.1);border-radius:6px;background:rgba(255,255,255,0.6);}
  #menu button{width:100%;justify-content:center;padding:16px 10px;font-size:15px;text-align:center;color:#000;}
  #menu button i{display:block;font-size:20px;margin-bottom:4px;}
  #menu .submenu{display:none;position:static;box-shadow:none;background:#fff;margin-top:2px;border-radius:4px;}
  #menu .submenu button{text-align:left;padding:10px 14px;font-size:14px;color:#333;}
  #menu .submenu button:hover{background:#f0f0f0;color:#007bff;}
  #menu .menu>li.open>.submenu{display:block;}
}
/* ===== MAP + FOOTER ===== */
#map{height:calc(100vh - 100px);width:100%;margin:0;padding:0;}
#footerTitle{position:fixed;bottom:0;left:0;width:100%;margin:0;padding:4px 6px;background:rgba(255,255,255,0.85);text-align:center;font-size:13px;box-shadow:0 -1px 4px rgba(0,0,0,0.15);z-index:1000;}
/* ===== LABEL & TOGGLE ===== */
.custom-label{font-weight:200;font-size:13px;color:#000;text-align:center;white-space:nowrap;}
.toggle-labels-btn{background:#fff;border:1px solid #bbb;border-radius:6px;padding:6px 10px;font-size:14px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.15);margin-bottom:40px;}
.toggle-labels-btn:hover{background:#f0f0f0;}
#infoBox{position:fixed;bottom:40px;left:10px;background:rgba(255,255,255,0.9);border:1px solid #ccc;padding:8px 12px;font-size:14px;font-weight:bold;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);z-index:1200;}
/* ===== TASK PANEL ===== */
#taskPanel{position:fixed;top:60px;right:10px;width:280px;background:rgba(255,255,255,0.95);border:1px solid #ccc;padding:10px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);z-index:1200;display:none;}
#taskPanel label{font-weight:bold;}
#taskList{max-height:300px;overflow:auto;font-size:14px;margin-top:6px;}
#closeTasksBtn{
  background:none;
  border:none;
  color:#000;
  font-size:18px;
  cursor:pointer;
}

#taskPanel .task-content{
  max-height:250px;
  overflow:auto;
  padding:10px 14px;
  font-size:14px;
  line-height:1.4;
}

#taskPanel .date-label{
  display:block;
  margin:8px 14px 4px;
  font-weight:bold;
}

#taskDate{
  width:calc(100% - 28px);
  margin:0 14px 12px;
  padding:6px 8px;
  border:1px solid #ccc;
  border-radius:6px;
}

@media (max-width:768px){
  #taskPanel{
    top:auto;
    bottom:120px;  /* Ä‘áº©y xuá»‘ng thÃªm Ä‘á»ƒ khÃ´ng che menu */
    right:5px;
    left:auto;
    width:90%;
  }
}

#taskPanel .panel-header {
  position: relative;       /* Ä‘á»ƒ tiÃªu Ä‘á» váº«n hiá»ƒn thá»‹ bÃ¬nh thÆ°á»ng */
  padding-right: 35px;      /* chá»«a khoáº£ng cho nÃºt X */
}

#closeTasksBtn {
  position: absolute;
  top: 0;                   /* sÃ¡t cáº¡nh trÃªn cá»§a .panel-header */
  right: 0;                 /* sÃ¡t mÃ©p pháº£i panel */
  background: none;
  border: none;
  font-size: 18px;          /* tuá»³ chá»‰nh */
  cursor: pointer;
  line-height: 1;           /* trÃ¡nh dÃ­nh khoáº£ng trá»‘ng */
}

.lot-item:hover { cursor:pointer; background:#f9f9f9; }
</style>
</head>
<body>
<nav id="menu">
<ul class="menu">
<li><button>ğŸŒ± CÃ¢y trá»“ng â–¾</button>
<ul class="submenu">
<li><button data-crop="all">ğŸŒ Tá»•ng thá»ƒ</button></li>
<li><button data-crop="Cá»">ğŸŒ± Cá»</button></li>
<li><button data-crop="NgÃ´">ğŸŒ½ NgÃ´</button></li>
<li><button data-crop="Sáº¯n">ğŸ¥” Sáº¯n</button></li>
<li><button data-crop="Äáº¥t trá»‘ng">â¬œ Äáº¥t trá»‘ng</button></li>
</ul></li>
<li><button>ğŸ› ï¸ CÃ´ng viá»‡c â–¾</button>
<ul class="submenu">
<li><button id="dailyTaskBtn">ğŸ“… CÃ´ng viá»‡c hÃ ng ngÃ y</button></li>
<li><button>ğŸ“ LÆ°u Ã½ cÃ´ng viá»‡c</button></li>
<li><button>ğŸ“Š BÃ¡o cÃ¡o tuáº§n</button></li>
</ul></li>
<li><button>ğŸ—ï¸ Háº¡ táº§ng â–¾</button>
<ul class="submenu">
<li><button>ğŸ’§ Há»‡ thá»‘ng tÆ°á»›i</button></li>
<li><button>ğŸšœ MÃ¡y mÃ³c</button></li>
</ul></li>
<li><button>ğŸ“œ PhÃ¡p lÃ½ â–¾</button>
<ul class="submenu">
<li><button>ğŸ“– Sá»• Ä‘á»</button></li>
</ul></li>
</ul>
</nav>

<div id="map"></div>
<h2 id="footerTitle">Báº£n Ä‘á»“ trá»“ng trá»t HÃ²a PhÃ¡t Quáº£ng BÃ¬nh</h2>
<div id="infoBox" style="display:none;"></div>

<div id="taskPanel">
<div class="panel-header">
  <span id="taskPanelTitle">CÃ´ng viá»‡c hÃ ng ngÃ y</span>
  <button id="closeTasksBtn">âœ–</button>
</div>


  <div id="taskList" class="task-content">
    <!-- Danh sÃ¡ch cÃ´ng viá»‡c sáº½ Ä‘Æ°á»£c load tá»± Ä‘á»™ng -->
  </div>

  <label for="taskDate" class="date-label">Chá»n ngÃ y:</label>
  <input type="date" id="taskDate">
</div>


<script>
window.onload=function(){
const sheetCropsUrl="https://docs.google.com/spreadsheets/d/13II_ZFEvrxK2qd0mkIX-0TNPdUH5ac4NFykmjqEPCZM/gviz/tq?tqx=out:json";
const sheetTaskUrl="https://docs.google.com/spreadsheets/d/13II_ZFEvrxK2qd0mkIX-0TNPdUH5ac4NFykmjqEPCZM/gviz/tq?tqx=out:json&gid=693737777";

let rowsData=[],polygons=[],currentFilter="all",labelsVisible=false;
let taskData=[],highlightLayers=[];

function parseDate_fromSheet(str){
  if(!str) return null;
  str=String(str).trim();
  if(str.includes("/")){
    const parts=str.split("/");
    if(parts.length===3){
      const day=parseInt(parts[0],10);
      const month=parseInt(parts[1],10)-1;
      const year=parseInt(parts[2],10);
      return new Date(Date.UTC(year,month,day));
    }
  }
  const match=str.match(/Date\((\d+),(\d+),(\d+)\)/);
  if(match){
    const year=parseInt(match[1],10);
    const month=parseInt(match[2],10);
    const day=parseInt(match[3],10);
    return new Date(Date.UTC(year,month,day));
  }
  return null;
}

function parseTaskDate(dateStr){
  if(!dateStr) return null;

  // Báº¯t dáº¡ng: Date(YYYY,M,D)
  const m = dateStr.match(/Date\((\d+),(\d+),(\d+)\)/);
  if (m) {
    // ThÃ¡ng trong JS tÃ­nh tá»« 0 nÃªn giá»¯ nguyÃªn m[2]
    return new Date(+m[1], +m[2], +m[3]);
  }

  // Thá»­ parse chuáº©n ISO
  const d = new Date(dateStr);
  return isNaN(d) ? null : d;
}


// map
const map=L.map('map',{center:[17.5089721,106.4670833],zoom:13,zoomControl:false});
L.control.zoom({position:'bottomright'}).addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
const polygonGroup=L.layerGroup().addTo(map);

// toggle nhÃ£n
const toggleBtn=L.control({position:'bottomright'});
toggleBtn.onAdd=function(){
  const btn=L.DomUtil.create('button','toggle-labels-btn');
  btn.innerHTML="ğŸ‘ï¸ Hiá»‡n nhÃ£n";
  btn.onclick=function(){
    labelsVisible=!labelsVisible;
    polygons.forEach(p=>{if(labelsVisible) map.addLayer(p.myTooltip); else map.removeLayer(p.myTooltip);});
    btn.innerHTML=labelsVisible?"ğŸ™ˆ áº¨n nhÃ£n":"ğŸ‘ï¸ Hiá»‡n nhÃ£n";
  };
  return btn;
};
toggleBtn.addTo(map);

// drawData
function drawData(filterCrop){
  currentFilter=filterCrop;
  // ğŸ”¹ LuÃ´n táº¯t nhÃ£n khi Ä‘á»•i cháº¿ Ä‘á»™
  labelsVisible = false;
  document.querySelector('.toggle-labels-btn').innerHTML = "ğŸ‘ï¸ Hiá»‡n nhÃ£n";
  polygons.forEach(p=>{
    if (p.myTooltip) map.removeLayer(p.myTooltip);
  });

  polygonGroup.clearLayers();
  polygons = [];
  polygonGroup.clearLayers();
  polygons=[];
  let totalGrassArea=0,totalCassavaArea=0,totalCornArea=0;
  const today=new Date();

  rowsData.forEach(row=>{
    const [name,areaRaw,crop,stage,dateStr,coordsStr]=row.c.map(c=>c?.v);
    const area=parseFloat(areaRaw)||0;
    if(!coordsStr) return;
    if(filterCrop!=="all" && crop!==filterCrop) return;
    const coords=JSON.parse(coordsStr);

    let color="blue",fillColor="gray",fillOpacity=0.6,weight=0.5;

    const plantDate=parseDate_fromSheet(dateStr);
    const monthsElapsed=plantDate?((today-plantDate)/(1000*60*60*24*30)):0;

    if(filterCrop==="all"){
      if(crop==="Cá»") fillColor="yellow";
      else if(crop==="NgÃ´") fillColor="orange";
      else if(crop==="Sáº¯n") fillColor="green";
      else if(crop==="Äáº¥t trá»‘ng"){fillColor="brown";fillOpacity=0.3;}
    }else{
      if(crop==="Cá»"||crop==="Sáº¯n"){
        fillColor=(crop==="Cá»")?"yellow":"green";
        if(monthsElapsed>=3){color="red";weight=2;}
        if(monthsElapsed>=3) crop==="Cá»"?totalGrassArea+=area:totalCassavaArea+=area;
        fillOpacity=Math.min(1,monthsElapsed/6);
      }else if(crop==="NgÃ´"){
        fillColor="orange";
        if(monthsElapsed>=3){color="red";weight=2;totalCornArea+=area;}
        fillOpacity=Math.min(1,monthsElapsed/6);
      }else if(crop==="Äáº¥t trá»‘ng"){fillColor="brown";fillOpacity=0.3;}
    }

    const poly=L.polygon(coords,{color:color,weight:weight,fillColor:fillColor,fillOpacity:fillOpacity}).addTo(polygonGroup);
    poly.options.name=name;
    const displayDate = plantDate ? `${plantDate.getUTCDate()}/${plantDate.getUTCMonth()+1}/${plantDate.getUTCFullYear()}` : "ChÆ°a cÃ³";
    poly.bindPopup(`<b>${name}</b><br>Diá»‡n tÃ­ch: ${area} ha<br>CÃ¢y: ${crop}<br>Giai Ä‘oáº¡n: ${stage}<br>NgÃ y: ${displayDate}`);
    poly.myTooltip=L.tooltip({permanent:true,direction:'center',className:'custom-label'}).setContent(`${name}<br>${area} ha`).setLatLng(poly.getBounds().getCenter());
    if(labelsVisible) map.addLayer(poly.myTooltip);

    polygons.push(poly);
  });

  const box=document.getElementById("infoBox");
  if(filterCrop==="Cá»") {box.style.display="block";box.innerText=`ğŸŒ± Cá» Ä‘áº¿n háº¡n thu hoáº¡ch: ${totalGrassArea.toFixed(2)} ha`;}
  else if(filterCrop==="Sáº¯n"){box.style.display="block";box.innerText=`ğŸ¥” Sáº¯n Ä‘áº¿n háº¡n thu hoáº¡ch: ${totalCassavaArea.toFixed(2)} ha`;}
  else if(filterCrop==="NgÃ´"){box.style.display="block";box.innerText=`ğŸŒ½ NgÃ´ Ä‘áº¿n háº¡n thu hoáº¡ch: ${totalCornArea.toFixed(2)} ha`;}
  else{box.style.display="none";}
}

// fetch crops sheet
fetch(sheetCropsUrl)
.then(res=>res.text())
.then(data=>{
  const match=data.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
  if(!match){console.error("KhÃ´ng parse Ä‘Æ°á»£c dá»¯ liá»‡u tá»« Google Sheet");return;}
  try{rowsData=JSON.parse(match[1]).table.rows;drawData("all");}catch(err){console.error("Lá»—i parse JSON:",err);}
})
.catch(err=>console.error("Lá»—i fetch Google Sheet:",err));

// filter crop buttons
document.querySelectorAll("[data-crop]").forEach(btn=>btn.addEventListener("click",function(){
  drawData(this.getAttribute("data-crop"));
}));

// mobile menu
if(window.innerWidth<=768){
  document.querySelectorAll("#menu .menu>li>button").forEach(btn=>{
    btn.addEventListener("click",function(e){
      e.preventDefault();
      const li=this.parentElement;
      document.querySelectorAll("#menu .menu>li").forEach(item=>{if(item!==li) item.classList.remove("open");});
      li.classList.toggle("open");
    });
  });
}

// TASK PANEL
const taskPanel = document.getElementById("taskPanel");
const taskDateInput = document.getElementById("taskDate");
const taskListDiv = document.getElementById("taskList");

// click button daily task
document.getElementById("dailyTaskBtn").addEventListener("click",function(){
  // ğŸ”¹ Khi má»Ÿ panel, luÃ´n Ä‘Æ°a báº£n Ä‘á»“ vá» cháº¿ Ä‘á»™ Tá»•ng thá»ƒ
  drawData("all");
  document.querySelector('.toggle-labels-btn').innerHTML = "ğŸ‘ï¸ Hiá»‡n nhÃ£n";
  labelsVisible = false;

  // ğŸ”¹ Set ngÃ y hiá»‡n táº¡i cho input
  const today = new Date();
  const isoToday = today.toISOString().split('T')[0]; // yyyy-mm-dd
  taskDateInput.value = isoToday;

  // ğŸ”¹ Äá»•i tiÃªu Ä‘á»
  document.getElementById("taskPanelTitle").textContent =
      "CÃ´ng viá»‡c ngÃ y " +
      today.getDate().toString().padStart(2,'0') + "/" +
      (today.getMonth()+1).toString().padStart(2,'0') + "/" +
      today.getFullYear();

  // ğŸ”¹ Hiá»ƒn thá»‹ panel vÃ  load cÃ´ng viá»‡c cá»§a hÃ´m nay
  taskPanel.style.display = "block";
  showTasks();
});


taskDateInput.addEventListener("change", showTasks);
  // nÃºt Ä‘Ã³ng
document.getElementById("closeTasksBtn").addEventListener("click",function(){
  taskPanel.style.display="none";
  highlightLayers.forEach(l=>polygonGroup.removeLayer(l));
  highlightLayers=[];
  taskListDiv.innerHTML="";
});
// fetch task sheet
fetch(sheetTaskUrl)
  .then(res => res.text())
  .then(data => {
    const match = data.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
    if(match){
      taskData = JSON.parse(match[1]).table.rows;
    }
  });

// handle date change
function showTasks(){
// cáº­p nháº­t tiÃªu Ä‘á» khi Ä‘á»•i ngÃ y
if (taskDateInput.value) {
  const d = new Date(taskDateInput.value);
  document.getElementById("taskPanelTitle").textContent =
      "CÃ´ng viá»‡c ngÃ y " +
      d.getDate().toString().padStart(2,'0') + "/" +
      (d.getMonth()+1).toString().padStart(2,'0') + "/" +
      d.getFullYear();
}
  const selectedDate = new Date(taskDateInput.value);
  if(!taskDateInput.value) return;
  console.log("selectedDate:", selectedDate.toDateString(), taskDateInput.value);
  // xÃ³a highlight cÅ©
  highlightLayers.forEach(l=>polygonGroup.removeLayer(l));
  highlightLayers = [];

  const dayTasks = taskData.filter(row=>{
    const [stt,dateStr,lot,content,quantity]=row.c.map(c=>c?.v);
    const date = parseTaskDate(dateStr);
        // âœï¸ ThÃªm dÃ²ng nÃ y Ä‘á»ƒ kiá»ƒm tra:
    console.log("sheet date:", dateStr, "â†’ parsed:", date,
                "compare with selected:", selectedDate);
    return date && date.toDateString()===selectedDate.toDateString();
  });

  taskListDiv.innerHTML="";
  const lotTasksMap={};

  dayTasks.forEach(row=>{
    const [stt,dateStr,lot,content,quantity]=row.c.map(c=>c?.v);
    if(!lot) return;
    if(!lotTasksMap[lot]) lotTasksMap[lot]=[];
    lotTasksMap[lot].push({content,quantity});
  });

  for(const lot in lotTasksMap){
    const poly = polygons.find(p=>p.options.name===lot || p.myTooltip?.getContent()?.includes(lot));
    if(poly){
      const highlight = L.polygon(poly.getLatLngs(),{color:'red',weight:3,fill:false}).addTo(polygonGroup);
      highlightLayers.push(highlight);
    }

    const tasksHTML = lotTasksMap[lot].map(t=>`- ${t.content} (${t.quantity})`).join("<br>");
    taskListDiv.innerHTML += `
    <div class="lot-item" data-lot="${lot}">
      <b>LÃ´ ${lot}</b><br>${tasksHTML}
    </div><hr>`;
// Gáº¯n sá»± kiá»‡n hover cho tá»«ng dÃ²ng cÃ´ng viá»‡c
document.querySelectorAll('#taskList .lot-item').forEach(item=>{
  let blinkTimer;
  item.addEventListener('mouseenter', ()=>{
    const lotName = item.dataset.lot;
    const poly = polygons.find(p=>p.options.name===lotName);
    if(!poly) return;

    // LÆ°u style gá»‘c
    const original = {
      fillColor: poly.options.fillColor || 'red', // náº¿u chÆ°a cÃ³ sáº½ dÃ¹ng Ä‘á»
      fillOpacity: poly.options.fillOpacity || 0
    };

    let visible = false;
    blinkTimer = setInterval(()=>{
      if (visible) {
        // trá»Ÿ láº¡i trong suá»‘t
        poly.setStyle({ fillOpacity: 0 });
      } else {
        // ğŸ”´ tÃ´ ná»n Ä‘á» má»
        poly.setStyle({ fillColor: 'red', fillOpacity: 0.4 });
      }
      visible = !visible;
    }, 400); // tá»‘c Ä‘á»™ nháº¥p nhÃ¡y 0.4s

    item.dataset.blinkTimer = blinkTimer;
    item.dataset.origFillColor = original.fillColor;
    item.dataset.origFillOpacity = original.fillOpacity;
  });

  item.addEventListener('mouseleave', ()=>{
    const lotName = item.dataset.lot;
    const poly = polygons.find(p=>p.options.name===lotName);
    if(poly){
      // Tráº£ láº¡i ná»n gá»‘c
      poly.setStyle({
        fillColor: item.dataset.origFillColor,
        fillOpacity: Number(item.dataset.origFillOpacity)
      });
    }
    clearInterval(item.dataset.blinkTimer);
  });
});

  }
}



// nÃºt â€œÄÃ³ngâ€: áº©n panel + xÃ³a highlight
document.getElementById("closeTasksBtn").addEventListener("click",function(){
  taskPanel.style.display="none";
  highlightLayers.forEach(l=>polygonGroup.removeLayer(l));
  highlightLayers=[];
  taskListDiv.innerHTML="";
});
};
</script>
</body>
</html>


























