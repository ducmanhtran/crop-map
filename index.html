<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Bản đồ trồng trọt</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
/* ===== MENU ===== */
#menu{background:linear-gradient(90deg,#007bff,#0056b3);box-shadow:0 2px 6px rgba(0,0,0,0.25);position:relative;z-index:1000;font-family:Arial,sans-serif;}
#menu .menu{list-style:none;margin:0;padding:0;display:flex;justify-content:center;}
#menu .menu>li{position:relative;}
#menu button{background:none;border:none;padding:14px 20px;font-size:15px;color:#fff;font-weight:600;cursor:pointer;transition:background 0.3s;display:flex;align-items:center;gap:6px;}
#menu button:hover{background:rgba(0,0,0,0.05);color:#007bff;}
#menu .submenu{display:none;position:absolute;top:100%;left:0;background:#fff;list-style:none;margin:0;padding:6px 0;box-shadow:0 2px 6px rgba(0,0,0,0.25);min-width:220px;border-radius:4px;}
#menu .submenu li{text-align:left;padding:4px 12px;}
#menu .submenu label{font-size:14px;color:#333;display:block;cursor:pointer;}
#menu .menu>li:hover>.submenu{display:block;}
@media(max-width:768px){
  #menu .menu{display:grid;grid-template-columns:1fr 1fr;grid-gap:4px;padding:4px;}
  #menu .menu>li{border:1px solid rgba(0,0,0,0.1);border-radius:6px;background:rgba(255,255,255,0.6);}
  #menu button{width:100%;justify-content:center;padding:16px 10px;font-size:15px;text-align:center;color:#000;}
  #menu .submenu{display:none;position:static;box-shadow:none;background:#fff;margin-top:2px;border-radius:4px;}
  #menu .menu>li.open>.submenu{display:block;}
}
#map{height:calc(100vh - 100px);width:100%;margin:0;padding:0;}
#footerTitle{position:fixed;bottom:0;left:0;width:100%;margin:0;padding:4px 6px;background:rgba(255,255,255,0.85);text-align:center;font-size:13px;box-shadow:0 -1px 4px rgba(0,0,0,0.15);z-index:1000;}
.custom-label{font-weight:200;font-size:13px;color:#000;text-align:center;white-space:nowrap;}
.toggle-labels-btn{background:#fff;border:1px solid #bbb;border-radius:6px;padding:6px 10px;font-size:14px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.15);margin-bottom:40px;}
.toggle-labels-btn:hover{background:#f0f0f0;}
</style>
</head>
<body>
<nav id="menu">
<ul class="menu">
<li><button>🌱 Cây trồng ▾</button>
  <ul class="submenu">
    <li><button data-crop="all">🌍 Tổng thể</button></li>
    <li><button data-crop="Cỏ">🌱 Cỏ</button></li>
    <li><button data-crop="Ngô">🌽 Ngô</button></li>
    <li><button data-crop="Sắn">🥔 Sắn</button></li>
    <li><button data-crop="Đất trống">⬜ Đất trống</button></li>
  </ul>
</li>
<li><button>🛠️ Công việc ▾</button>
  <ul class="submenu">
    <li><button id="dailyTaskBtn">📅 Công việc hàng ngày</button></li>
  </ul>
</li>
<li><button>🏗️ Hạ tầng ▾</button>
  <ul class="submenu">
    <li><button>💧 Hệ thống tưới</button></li>
    <li><button>🚜 Máy móc</button></li>
  </ul>
</li>
<li><button>📜 Pháp lý ▾</button>
  <ul class="submenu">
    <li><label><input type="checkbox" id="chkCompanyLegal"> Sổ đỏ công ty</label></li>
    <li><label><input type="checkbox" id="chkActualLots"> Lô đất thực tế (dữ liệu trồng trọt)</label></li>
    <li><label><input type="checkbox" id="chkDisputed"> Đất lấn chiếm / tranh chấp</label></li>
  </ul>
</li>
</ul>
</nav>

<div id="map"></div>
<h2 id="footerTitle">Bản đồ trồng trọt Hòa Phát Quảng Bình</h2>

<script>
window.onload=function(){

const sheetCropsUrl   = "https://docs.google.com/spreadsheets/d/13II_ZFEvrxK2qd0mkIX-0TNPdUH5ac4NFykmjqEPCZM/gviz/tq?tqx=out:json";
const sheetLegalUrl   = "https://docs.google.com/spreadsheets/d/1yLzyQRiZjOxwXDNL2gKtzTULA9ODTcS0bLXTOxqELBE/gviz/tq?tqx=out:json";
const sheetDisputedUrl= "https://docs.google.com/spreadsheets/d/1yLzyQRiZjOxwXDNL2gKtzTULA9ODTcS0bLXTOxqELBE/gviz/tq?tqx=out:json&gid=162449209";

let rowsData=[], polygons=[], labelsVisible=false;

const map=L.map('map',{center:[17.5089721,106.4670833],zoom:13,zoomControl:false});
L.control.zoom({position:'bottomright'}).addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

const cropsGroup        = L.layerGroup().addTo(map);
const companyLegalGroup = L.layerGroup().addTo(map);
const actualLotsGroup   = L.layerGroup().addTo(map);
const disputedGroup     = L.layerGroup().addTo(map);

const toggleBtn=L.control({position:'bottomright'});
toggleBtn.onAdd=function(){
  const btn=L.DomUtil.create('button','toggle-labels-btn');
  btn.innerHTML="👁️ Hiện nhãn";
  btn.onclick=function(){
    labelsVisible=!labelsVisible;
    polygons.forEach(p=>{
      if(labelsVisible) map.addLayer(p.myTooltip); else map.removeLayer(p.myTooltip);
    });
    btn.innerHTML=labelsVisible?"🙈 Ẩn nhãn":"👁️ Hiện nhãn";
  };
  return btn;
};
toggleBtn.addTo(map);

fetch(sheetCropsUrl).then(r=>r.text()).then(txt=>{
  const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
  if(!m) return;
  rowsData=JSON.parse(m[1]).table.rows;
  drawCrops("all");
});

function parseDate_fromSheet(str){
  if(!str) return null;
  const parts=str.split("/");
  if(parts.length===3){
    return new Date(parts[2],parts[1]-1,parts[0]);
  }
  return null;
}

function drawCrops(filterCrop){
  cropsGroup.clearLayers();
  polygons=[];
  const today=new Date();
  rowsData.forEach(r=>{
    const [name,areaRaw,crop,stage,dateStr,coordsStr]=r.c.map(c=>c?.v);
    if(filterCrop!=="all" && crop!==filterCrop) return;
    if(!coordsStr) return;
    const coords=JSON.parse(coordsStr);
    const plantDate=parseDate_fromSheet(dateStr);
    const monthsElapsed=plantDate?((today-plantDate)/(1000*60*60*24*30)):0;

    let fillColor="gray";
    if(crop==="Cỏ") fillColor="yellow";
    else if(crop==="Ngô") fillColor="orange";
    else if(crop==="Sắn") fillColor="green";
    else if(crop==="Đất trống") fillColor="brown";

    const poly=L.polygon(coords,{color:'blue',weight:1,fillColor,fillOpacity:0.6}).addTo(cropsGroup);
    poly.myTooltip=L.tooltip({permanent:true,direction:"center",className:"custom-label"})
      .setContent(`${name}<br>${areaRaw} ha`)
      .setLatLng(poly.getBounds().getCenter());
    polygons.push(poly);
  });
}

function drawCompanyLegal(){
  companyLegalGroup.clearLayers();
  fetch(sheetLegalUrl).then(r=>r.text()).then(txt=>{
    const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
    if(!m) return;
    const rows=JSON.parse(m[1]).table.rows;
    rows.forEach(r=>{
      const [stt,name,areaRaw,coordsStr,note]=r.c.map(c=>c?.v);
      if(!coordsStr) return;
      L.polygon(JSON.parse(coordsStr),{
        color:'blue',weight:1,fillColor:'#add8e6',fillOpacity:0.4
      }).bindPopup(`<b>${name}</b><br>${note||""}`).addTo(companyLegalGroup);
    });
  });
}

function drawActualLots(){
  actualLotsGroup.clearLayers();
  rowsData.forEach(r=>{
    const [name,areaRaw,crop,stage,dateStr,coordsStr]=r.c.map(c=>c?.v);
    if(!coordsStr) return;
    L.polygon(JSON.parse(coordsStr),{
      color:'green',weight:1,fillColor:'#b0f2b6',fillOpacity:0.4
    }).bindPopup(`<b>${name}</b><br>${areaRaw} ha`).addTo(actualLotsGroup);
  });
}

function drawDisputedLots(){
  disputedGroup.clearLayers();
  fetch(sheetDisputedUrl).then(r=>r.text()).then(txt=>{
    const m=txt.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
    if(!m) return;
    const rows=JSON.parse(m[1]).table.rows;
    rows.forEach(r=>{
      const [stt,name,areaRaw,coordsStr,note]=r.c.map(c=>c?.v);
      if(!coordsStr) return;
      L.polygon(JSON.parse(coordsStr),{
        color:'red',weight:2,fillColor:'#f5b7b1',fillOpacity:0.5
      }).bindPopup(`<b>${name}</b><br>${note||""}`).addTo(disputedGroup);
    });
  });
}

// khi bật checkbox pháp lý -> tắt nhóm cây trồng
document.getElementById("chkCompanyLegal").addEventListener("change",function(){
  if(this.checked){ map.removeLayer(cropsGroup); drawCompanyLegal(); map.addLayer(companyLegalGroup);} 
  else{ companyLegalGroup.clearLayers(); map.removeLayer(companyLegalGroup); if(!anyLegalChecked()) map.addLayer(cropsGroup);}
});
document.getElementById("chkActualLots").addEventListener("change",function(){
  if(this.checked){ map.removeLayer(cropsGroup); drawActualLots(); map.addLayer(actualLotsGroup);} 
  else{ actualLotsGroup.clearLayers(); map.removeLayer(actualLotsGroup); if(!anyLegalChecked()) map.addLayer(cropsGroup);}
});
document.getElementById("chkDisputed").addEventListener("change",function(){
  if(this.checked){ map.removeLayer(cropsGroup); drawDisputedLots(); map.addLayer(disputedGroup);} 
  else{ disputedGroup.clearLayers(); map.removeLayer(disputedGroup); if(!anyLegalChecked()) map.addLayer(cropsGroup);}
});

function anyLegalChecked(){
  return document.getElementById("chkCompanyLegal").checked ||
         document.getElementById("chkActualLots").checked ||
         document.getElementById("chkDisputed").checked;
}

document.querySelectorAll("[data-crop]").forEach(btn=>btn.addEventListener("click",function(){
  drawCrops(this.dataset.crop);
}));

if(window.innerWidth<=768){
  document.querySelectorAll("#menu .menu>li>button").forEach(btn=>{
    btn.addEventListener("click",function(e){
      e.preventDefault();
      const li=this.parentElement;
      document.querySelectorAll("#menu .menu>li").forEach(item=>{if(item!==li) item.classList.remove("open");});
      li.classList.toggle("open");
    });
  });
}

};
</script>
</body>
</html>
