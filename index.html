<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báº£n Ä‘á»“ trá»“ng trá»t</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
  /* ===== MENU NGANG ===== */
  #menu { background: linear-gradient(90deg,#007bff,#0056b3); box-shadow:0 2px 6px rgba(0,0,0,0.25); position:relative; z-index:1000; font-family:Arial,sans-serif; }
  #menu .menu { list-style:none;margin:0;padding:0; display:flex; justify-content:center; }
  #menu .menu>li { position:relative; }
  #menu button { background:none;border:none;padding:14px 20px;font-size:15px;color:#fff;font-weight:600;cursor:pointer;transition:background 0.3s;display:flex;align-items:center;gap:6px;}
  #menu button:hover{background:rgba(0,0,0,0.05);color:#007bff;}
  #menu .submenu { display:none;position:absolute;top:100%;left:0;background:#fff;list-style:none;margin:0;padding:6px 0;box-shadow:0 2px 6px rgba(0,0,0,0.25);min-width:200px;border-radius:4px; }
  #menu .submenu li{text-align:left;}
  #menu .submenu button{width:100%;text-align:left;padding:10px 14px;font-size:14px;color:#333;background:none;border:none;}
  #menu .submenu button:hover{background:#f0f0f0;color:#007bff;}
  #menu .menu>li:hover>.submenu{display:block;}

  @media(max-width:768px){
    #infoBox{bottom:80px;left:5px;font-size:13px;padding:6px 10px;}
    #menu .menu{display:grid;grid-template-columns:1fr 1fr;grid-gap:4px;padding:4px;}
    #menu .menu>li{border:1px solid rgba(0,0,0,0.1);border-radius:6px;background:rgba(255,255,255,0.6);}
    #menu button{width:100%;justify-content:center;padding:16px 10px;font-size:15px;text-align:center;color:#000;}
    #menu button i{display:block;font-size:20px;margin-bottom:4px;}
    #menu .submenu{display:none;position:static;box-shadow:none;background:#fff;margin-top:2px;border-radius:4px;}
    #menu .submenu button{text-align:left;padding:10px 14px;font-size:14px;color:#333;}
    #menu .submenu button:hover{background:#f0f0f0;color:#007bff;}
    #menu .menu>li.open>.submenu{display:block;}
  }

  #map{height:calc(100vh - 100px);width:100%;margin:0;padding:0;}
  #footerTitle{position:fixed;bottom:0;left:0;width:100%;margin:0;padding:4px 6px;background:rgba(255,255,255,0.85);text-align:center;font-size:13px;box-shadow:0 -1px 4px rgba(0,0,0,0.15);z-index:1000;}
  .custom-label{font-weight:200;font-size:13px;color:#000;text-align:center;white-space:nowrap;}
  .toggle-labels-btn{background:#fff;border:1px solid #bbb;border-radius:6px;padding:6px 10px;font-size:14px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.15);margin-bottom:40px;}
  .toggle-labels-btn:hover{background:#f0f0f0;}
  #infoBox{position:fixed;bottom:40px;left:10px;background:rgba(255,255,255,0.9);border:1px solid #ccc;padding:8px 12px;font-size:14px;font-weight:bold;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.2);z-index:1200;}
  </style>
</head>
<body>
<nav id="menu">
<ul class="menu">
<li><button>ğŸŒ± CÃ¢y trá»“ng â–¾</button>
<ul class="submenu">
<li><button data-crop="all">ğŸŒ Tá»•ng thá»ƒ</button></li>
<li><button data-crop="Cá»">ğŸŒ± Cá»</button></li>
<li><button data-crop="NgÃ´">ğŸŒ½ NgÃ´</button></li>
<li><button data-crop="Sáº¯n">ğŸ¥” Sáº¯n</button></li>
<li><button data-crop="Äáº¥t trá»‘ng">â¬œ Äáº¥t trá»‘ng</button></li>
</ul></li>
<li><button>ğŸ› ï¸ CÃ´ng viá»‡c â–¾</button>
<ul class="submenu">
<li><button>ğŸ“… CÃ´ng viá»‡c hÃ ng ngÃ y</button></li>
<li><button>ğŸ“ LÆ°u Ã½ cÃ´ng viá»‡c</button></li>
<li><button>ğŸ“Š BÃ¡o cÃ¡o tuáº§n</button></li>
</ul></li>
<li><button>ğŸ—ï¸ Háº¡ táº§ng â–¾</button>
<ul class="submenu">
<li><button>ğŸ’§ Há»‡ thá»‘ng tÆ°á»›i</button></li>
<li><button>ğŸšœ MÃ¡y mÃ³c</button></li>
</ul></li>
<li><button>ğŸ“œ PhÃ¡p lÃ½ â–¾</button>
<ul class="submenu">
<li><button>ğŸ“– Sá»• Ä‘á»</button></li>
</ul></li>
</ul>
</nav>

<div id="map"></div>
<h2 id="footerTitle">Báº£n Ä‘á»“ trá»“ng trá»t HÃ²a PhÃ¡t Quáº£ng BÃ¬nh</h2>
<div id="infoBox" style="display:none;"></div>

<script>
window.onload = function() {
  const sheetCropsUrl = "https://docs.google.com/spreadsheets/d/13II_ZFEvrxK2qd0mkIX-0TNPdUH5ac4NFykmjqEPCZM/gviz/tq?tqx=out:json";
  let rowsData = [], currentFilter = "all", labelsVisible = false;

  function parseDate_fromSheet(str){
    if(!str) return null;
    str = String(str).trim();
    if(str.includes("/")){
      const p = str.split("/");
      if(p.length===3) return new Date(p[2], p[1]-1, p[0]);
    }
    const m = str.match(/Date\((\d+),(\d+),(\d+)\)/);
    if(m) return new Date(parseInt(m[1]), parseInt(m[2]), parseInt(m[3]));
    return null;
  }

  function interpolateColor(c1,c2,t){
    const a=parseInt(c1.slice(1),16), b=parseInt(c2.slice(1),16);
    const r=Math.round(((b>>16)&0xFF)*t+((a>>16)&0xFF)*(1-t));
    const g=Math.round(((b>>8)&0xFF)*t+((a>>8)&0xFF)*(1-t));
    const bl=Math.round((b&0xFF)*t+(a&0xFF)*(1-t));
    return `rgb(${r},${g},${bl})`;
  }

  const map = L.map('map',{center:[17.5089721,106.4670833],zoom:13,zoomControl:false});
  L.control.zoom({position:'bottomright'}).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

  const polygonGroup = L.layerGroup().addTo(map);

  const toggleBtn = L.control({ position: 'bottomright' });
  toggleBtn.onAdd = function() {
    const btn = L.DomUtil.create('button','toggle-labels-btn');
    btn.innerHTML = "ğŸ‘ï¸ Hiá»‡n nhÃ£n";
    btn.onclick = function() {
      labelsVisible = !labelsVisible;
      btn.innerHTML = labelsVisible ? "ğŸ™ˆ áº¨n nhÃ£n" : "ğŸ‘ï¸ Hiá»‡n nhÃ£n";
      polygonGroup.eachLayer(poly => {
        if(labelsVisible) poly.openTooltip();
        else poly.closeTooltip();
      });
    };
    return btn;
  };
  toggleBtn.addTo(map);

  function drawData(filterCrop){
    currentFilter = filterCrop;
    polygonGroup.clearLayers();
    let totalGrassArea=0, totalCassavaArea=0;
    const today=new Date();

    rowsData.forEach(row=>{
      const [name, areaRaw, crop, stage, dateStr, coordsStr] = row.c.map(c=>c?.v);
      const area = parseFloat(areaRaw)||0;
      if(!coordsStr) return;
      if(filterCrop!=="all" && crop!==filterCrop) return;
      const coords = JSON.parse(coordsStr);

      let color="blue", fillColor="gray", fillOpacity=0.6, weight=0.5;

      if(filterCrop==="all"){
        if(crop==="Cá»") fillColor="#FFFF99";
        else if(crop==="NgÃ´") fillColor="orange";
        else if(crop==="Sáº¯n") fillColor="#99FF99";
        else if(crop==="Äáº¥t trá»‘ng"){ fillColor="brown"; fillOpacity=0.3; }
      } else {
        if(crop==="Cá»"){
          const harvestDate = parseDate_fromSheet(dateStr);
          let t=0;
          if(harvestDate){
            const days=Math.floor((today-harvestDate)/(1000*60*60*24));
            t=Math.min(Math.max(days/90,0),1);
            fillOpacity=Math.max(0.3,t);
            if(days>=90){ color="red"; weight=2; totalGrassArea+=area; }
          } else fillOpacity=0.3;
          fillColor = interpolateColor("#FFFFCC","#FFD700",t);
        } else if(crop==="NgÃ´") fillColor="orange";
        else if(crop==="Sáº¯n"){
          const plantedDate=parseDate_fromSheet(dateStr);
          let t=0;
          if(plantedDate){
            const months=(today-plantedDate)/(1000*60*60*24*30);
            t=Math.min(Math.max(months/10,0),1);
            fillOpacity=Math.max(0.3,t);
            if(months>=10){ color="red"; weight=2; totalCassavaArea+=area; }
          } else fillOpacity=0.3;
          fillColor = interpolateColor("#CCFFCC","#009900",t);
        } else if(crop==="Äáº¥t trá»‘ng"){ fillColor="brown"; fillOpacity=0.3; }
      }

      const poly = L.polygon(coords,{color,weight,fillColor,fillOpacity}).bindPopup(
        `<b>${name}</b><br>Diá»‡n tÃ­ch: ${area} ha<br>CÃ¢y: ${crop}<br>Giai Ä‘oáº¡n: ${stage}<br>NgÃ y: ${dateStr||"ChÆ°a cÃ³"}`
      );

      // Tooltip hover luÃ´n hiá»ƒn thá»‹ khi hover, permanent toggle
      poly.bindTooltip(`${name}<br>${area} ha`, { permanent: false, className:'custom-label', direction:'center' });

      if(labelsVisible) poly.openTooltip(); // Permanent náº¿u Ä‘ang báº­t

      polygonGroup.addLayer(poly);
    });

    const box = document.getElementById("infoBox");
    if(filterCrop==="Cá»"){ box.style.display="block"; box.innerText=`ğŸŒ± Cá» chÆ°a thu hoáº¡ch: ${totalGrassArea.toFixed(2)} ha`; }
    else if(filterCrop==="Sáº¯n"){ box.style.display="block"; box.innerText=`ğŸ¥” Sáº¯n Ä‘áº¿n háº¡n thu hoáº¡ch: ${totalCassavaArea.toFixed(2)} ha`; }
    else box.style.display="none";
  }

  fetch(sheetCropsUrl)
    .then(res=>res.text())
    .then(data=>{
      const match = data.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
      if(!match){ console.error("KhÃ´ng parse dá»¯ liá»‡u"); return; }
      rowsData = JSON.parse(match[1]).table.rows;
      drawData("all");
    }).catch(err=>console.error("Lá»—i fetch Google Sheet:",err));

  document.querySelectorAll("[data-crop]").forEach(btn=>{
    btn.addEventListener("click",()=>drawData(btn.getAttribute("data-crop")));
  });

  if(window.innerWidth <= 768){
    document.querySelectorAll("#menu .menu>li>button").forEach(btn=>{
      btn.addEventListener("click", function(e){
        e.preventDefault();
        const li=this.parentElement;
        document.querySelectorAll("#menu .menu>li").forEach(item=>{ if(item!==li)item.classList.remove("open"); });
        li.classList.toggle("open");
      });
    });
  }
};
</script>
</body>
</html>
